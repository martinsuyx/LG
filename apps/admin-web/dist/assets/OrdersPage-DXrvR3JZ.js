import{d as we,a as Z,r,c as O,w as Ce,o as Se,b as u,e as t,f as V,i as _,v as y,j as ee,F as M,h as $,t as o,k as xe,s as te,n as E,p as Ie,q as d,_ as Me}from"./index-DvtP9USg.js";import{O as P}from"./OrdersService-Bk90CBYk.js";import"./request-Bu45iIRO.js";const $e={class:"orders"},ze={class:"orders__head"},Oe={class:"orders__head-actions"},Ve=["disabled"],De={class:"filters__group"},Ne={class:"filters__row"},Fe={class:"filters__field"},Ue={class:"filters__field"},je={class:"filters__field"},Be=["value"],Ee={class:"filters__field"},Pe=["value"],Re={class:"filters__field"},Te={class:"filters__field"},Ae={class:"filters__field"},qe={class:"filters__field"},Le={class:"filters__actions"},Ke=["disabled"],Ye=["disabled"],Ge={key:0,class:"batch-bar"},He={class:"batch-bar__actions"},Je={class:"table-card"},Qe={class:"col-checkbox"},We=["checked"],Xe=["data-active"],Ze=["data-active"],et={key:0},tt={key:1},lt={class:"col-checkbox"},st=["checked","onChange"],nt=["onClick"],ot=["data-status"],at={class:"actions-col"},ut={class:"row-actions"},dt=["onClick"],rt=["onClick"],it={key:2},ct={class:"pager"},vt=["disabled"],pt=["disabled"],bt={class:"pager__size"},_t=["value"],ft=["value"],ht={key:1,class:"feedback feedback--error"},gt={key:2,class:"feedback"},mt={key:3,class:"modal"},yt={class:"modal__body"},kt={class:"modal__content"},wt={class:"modal__actions"},Ct={class:"modal__field"},St={class:"modal__footer"},xt=["disabled"],It={key:4,class:"modal"},Mt={class:"modal__body"},$t={class:"modal__content"},zt={class:"modal__list"},Ot={key:0},Vt={class:"modal__field"},Dt={class:"modal__footer"},Nt=["disabled"],Ft=we({__name:"OrdersPage",setup(Ut){const le=Ie(),R=new Date,T=R.toISOString().slice(0,10),F=new Date(R);F.setDate(F.getDate()-6);const A=F.toISOString().slice(0,10),s=Z({start:A,end:T,status:[],channel:"",storeCode:"",promoterId:"",orderId:"",phone:"",page:1,pageSize:20}),i=r([]),D=r(0),p=r(!1),g=r(""),z=r(""),k=r("created_at"),x=r("desc"),b=Z(new Set),U=r(!1),m=r(null),f=r("approve"),w=r(""),j=r(!1),C=r("approve"),S=r(""),q=[{value:"pending",label:"待提交"},{value:"auto_reject",label:"自动拒绝"},{value:"under_review",label:"待审核"},{value:"approved",label:"已通过"},{value:"rejected",label:"已驳回"},{value:"settled",label:"已结算"}],se=["wechat","h5","scan","api"],ne=[20,50,100,200],B=O(()=>Math.max(1,Math.ceil(D.value/s.pageSize))),h=O(()=>Array.from(b)),oe=O(()=>i.value.length?i.value.every(n=>b.has(n.order_id)):!1),ae=O(()=>w.value.length>=5&&!!f.value),ue=O(()=>S.value.length>=5&&h.value.length>0),de=new Intl.NumberFormat("zh-CN",{style:"currency",currency:"CNY",minimumFractionDigits:2}),re=new Intl.DateTimeFormat("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});let N=0;function L(n){const e=q.find(a=>a.value===n);return e?e.label:n}function K(n){return de.format(n)}function ie(n){try{return re.format(new Date(n))}catch{return n}}function ce(){s.start=A,s.end=T,s.status=[],s.channel="",s.storeCode="",s.promoterId="",s.orderId="",s.phone="",s.page=1,s.pageSize=20,I()}function ve(){s.page=1,I()}function pe(){I()}function Y(n){const e=Math.min(Math.max(n,1),B.value);e!==s.page&&(s.page=e)}function be(n){const e=n.target,a=Number(e.value);s.pageSize!==a&&(s.pageSize=a,s.page=1)}function G(n){k.value===n?x.value=x.value==="asc"?"desc":"asc":(k.value=n,x.value=n==="created_at"?"desc":"asc"),I()}function _e(n,e){e.target.checked?b.add(n):b.delete(n)}function fe(n){n.target.checked?i.value.forEach(a=>b.add(a.order_id)):i.value.forEach(a=>b.delete(a.order_id))}function he(){b.clear()}function H(n){le.push({path:`/orders/${n}`})}function ge(n){m.value=n,f.value="approve",w.value="",U.value=!0}function J(){U.value=!1,m.value=null,w.value=""}function Q(n){C.value=n,S.value="",j.value=!0}function W(){j.value=!1,S.value=""}function X(n){return n==="approve"?"approved":"rejected"}async function me(){if(!(!m.value||!f.value||w.value.length<5)){p.value=!0,g.value="";try{const n={action:f.value,note:w.value,reviewer_id:"demo-reviewer"},a=(await P.reviewOrder(m.value.order_id,n)).new_status??X(f.value),l=i.value.map(c=>{var v;return c.order_id===((v=m.value)==null?void 0:v.order_id)?{...c,status:a}:c});i.value=l,b.delete(m.value.order_id),z.value=`订单 ${m.value.order_id} 已标记为 ${L(a)}。`,J()}catch(n){g.value=(n==null?void 0:n.message)||"提交审核失败，请稍后再试。"}finally{p.value=!1}}}async function ye(){var n;if(!(!C.value||S.value.length<5||h.value.length===0)){p.value=!0,g.value="";try{const e={ids:h.value,action:C.value,note:S.value},a=await P.batchReviewOrders(e),l=X(C.value),c=new Set(a.processed_ids??e.ids);i.value=i.value.map(v=>c.has(v.order_id)?{...v,status:l}:v),(n=a.processed_ids)==null||n.forEach(v=>b.delete(v)),z.value=`批量${C.value==="approve"?"通过":"驳回"} ${c.size} 条订单成功。`,W()}catch(e){g.value=(e==null?void 0:e.message)||"批量审核失败，请稍后再试。"}finally{p.value=!1}}}function ke(n){return n?n.includes("Failed to fetch")||n.includes("NetworkError")?"无法连接到订单接口，请确认 Mock 服务已启动或网络可用。":n:"加载订单列表失败，请稍后再试。"}async function I(){p.value=!0,g.value="",z.value="";const n=++N;try{const e=s.status.length?s.status:void 0,a=s.channel?[s.channel]:void 0,l=await P.listOrders(s.start||void 0,s.end||void 0,e,a,s.storeCode||void 0,s.promoterId||void 0,s.orderId||void 0,s.phone||void 0,s.page,s.pageSize,k.value,x.value);if(n!==N)return;i.value=l.items??[],D.value=l.total??0;const c=new Set(i.value.map(v=>v.order_id));Array.from(b).forEach(v=>{c.has(v)||b.delete(v)})}catch(e){if(n!==N)return;g.value=ke(e==null?void 0:e.message),i.value=[],D.value=0}finally{n===N&&(p.value=!1)}}return Ce(()=>[s.page,s.pageSize],()=>{I()}),Se(()=>{I()}),(n,e)=>{var a;return d(),u("section",$e,[t("header",ze,[e[21]||(e[21]=t("div",null,[t("h1",{class:"orders__title"},"订单列表"),t("p",{class:"orders__subtitle"},"检索、审核与批量处理订单，支持查看详情与导出。")],-1)),t("div",Oe,[t("button",{type:"button",class:"btn",onClick:pe,disabled:p.value},"刷新",8,Ve),e[20]||(e[20]=t("button",{type:"button",class:"btn btn--ghost",disabled:""},"导出当前筛选",-1))])]),t("form",{class:"filters",onSubmit:xe(ve,["prevent"])},[t("fieldset",De,[e[31]||(e[31]=t("legend",null,"筛选条件",-1)),t("div",Ne,[t("label",Fe,[e[22]||(e[22]=t("span",null,"开始日期",-1)),_(t("input",{class:"input",type:"date","onUpdate:modelValue":e[0]||(e[0]=l=>s.start=l)},null,512),[[y,s.start]])]),t("label",Ue,[e[23]||(e[23]=t("span",null,"结束日期",-1)),_(t("input",{class:"input",type:"date","onUpdate:modelValue":e[1]||(e[1]=l=>s.end=l)},null,512),[[y,s.end]])]),t("label",je,[e[24]||(e[24]=t("span",null,"状态",-1)),_(t("select",{class:"input",multiple:"","onUpdate:modelValue":e[2]||(e[2]=l=>s.status=l)},[(d(),u(M,null,$(q,l=>t("option",{key:l.value,value:l.value},o(l.label),9,Be)),64))],512),[[ee,s.status]])]),t("label",Ee,[e[26]||(e[26]=t("span",null,"渠道",-1)),_(t("select",{class:"input","onUpdate:modelValue":e[3]||(e[3]=l=>s.channel=l)},[e[25]||(e[25]=t("option",{value:""},"全部",-1)),(d(),u(M,null,$(se,l=>t("option",{key:l,value:l},o(l),9,Pe)),64))],512),[[ee,s.channel]])]),t("label",Re,[e[27]||(e[27]=t("span",null,"门店编码",-1)),_(t("input",{class:"input",type:"text","onUpdate:modelValue":e[4]||(e[4]=l=>s.storeCode=l),placeholder:"如 S001"},null,512),[[y,s.storeCode,void 0,{trim:!0}]])]),t("label",Te,[e[28]||(e[28]=t("span",null,"推广人 ID",-1)),_(t("input",{class:"input",type:"text","onUpdate:modelValue":e[5]||(e[5]=l=>s.promoterId=l),placeholder:"如 P001"},null,512),[[y,s.promoterId,void 0,{trim:!0}]])]),t("label",Ae,[e[29]||(e[29]=t("span",null,"订单号",-1)),_(t("input",{class:"input",type:"text","onUpdate:modelValue":e[6]||(e[6]=l=>s.orderId=l),placeholder:"精确匹配"},null,512),[[y,s.orderId,void 0,{trim:!0}]])]),t("label",qe,[e[30]||(e[30]=t("span",null,"手机号",-1)),_(t("input",{class:"input",type:"text","onUpdate:modelValue":e[7]||(e[7]=l=>s.phone=l),placeholder:"支持模糊"},null,512),[[y,s.phone,void 0,{trim:!0}]])])]),t("div",Le,[t("button",{type:"submit",class:"btn",disabled:p.value},"应用筛选",8,Ke),t("button",{type:"button",class:"btn btn--ghost",onClick:ce,disabled:p.value},"重置",8,Ye)])])],32),h.value.length?(d(),u("div",Ge,[t("span",null,"已选中 "+o(h.value.length)+" 条",1),t("div",He,[t("button",{type:"button",class:"btn",onClick:e[8]||(e[8]=l=>Q("approve"))},"批量通过"),t("button",{type:"button",class:"btn btn--danger",onClick:e[9]||(e[9]=l=>Q("reject"))},"批量驳回"),t("button",{type:"button",class:"btn btn--ghost",onClick:he},"清空选择")])])):V("",!0),t("div",Je,[t("table",null,[t("thead",null,[t("tr",null,[t("th",Qe,[t("input",{type:"checkbox",checked:oe.value,onChange:e[10]||(e[10]=l=>fe(l))},null,40,We)]),t("th",{class:"sortable",onClick:e[11]||(e[11]=l=>G("created_at"))},[e[32]||(e[32]=te(" 下单时间 ",-1)),t("span",{class:"sort-indicator","data-active":k.value==="created_at"},o(k.value==="created_at"?x.value==="asc"?"↑":"↓":""),9,Xe)]),e[34]||(e[34]=t("th",null,"订单号",-1)),e[35]||(e[35]=t("th",null,"状态",-1)),e[36]||(e[36]=t("th",null,"渠道",-1)),e[37]||(e[37]=t("th",null,"门店",-1)),e[38]||(e[38]=t("th",null,"推广人",-1)),t("th",{class:"sortable",onClick:e[12]||(e[12]=l=>G("amount"))},[e[33]||(e[33]=te(" 金额 ",-1)),t("span",{class:"sort-indicator","data-active":k.value==="amount"},o(k.value==="amount"?x.value==="asc"?"↑":"↓":""),9,Ze)]),e[39]||(e[39]=t("th",null,"实际入账",-1)),e[40]||(e[40]=t("th",{class:"actions-col"},"操作",-1))])]),p.value?(d(),u("tbody",et,[(d(),u(M,null,$(5,l=>t("tr",{key:`loading-${l}`},[...e[41]||(e[41]=[t("td",{colspan:10},[t("div",{class:"skeleton"})],-1)])])),64))])):i.value.length?(d(),u("tbody",tt,[(d(!0),u(M,null,$(i.value,l=>(d(),u("tr",{key:l.order_id},[t("td",lt,[t("input",{type:"checkbox",checked:b.has(l.order_id),onChange:c=>_e(l.order_id,c)},null,40,st)]),t("td",null,o(ie(l.created_at)),1),t("td",null,[t("button",{type:"button",class:"link-btn",onClick:c=>H(l.order_id)},o(l.order_id),9,nt)]),t("td",null,[t("span",{class:"status-tag","data-status":l.status},o(L(l.status)),9,ot)]),t("td",null,o(l.channel),1),t("td",null,o(l.store_name),1),t("td",null,o(l.promoter_name),1),t("td",null,o(K(l.amount)),1),t("td",null,o(l.settled_amount!==null&&l.settled_amount!==void 0?K(l.settled_amount):"-"),1),t("td",at,[t("div",ut,[t("button",{type:"button",class:"link-btn",onClick:c=>H(l.order_id)},"详情",8,dt),t("button",{type:"button",class:"link-btn",onClick:c=>ge(l)},"审核",8,rt)])])]))),128))])):(d(),u("tbody",it,[...e[42]||(e[42]=[t("tr",null,[t("td",{colspan:10,class:"empty"},"暂无符合条件的订单")],-1)])]))])]),t("footer",ct,[t("button",{type:"button",class:"btn btn--ghost",disabled:s.page<=1||p.value,onClick:e[13]||(e[13]=l=>Y(s.page-1))},"上一页",8,vt),t("span",null,"第 "+o(s.page)+" / "+o(B.value)+" 页",1),t("button",{type:"button",class:"btn btn--ghost",disabled:s.page>=B.value||p.value,onClick:e[14]||(e[14]=l=>Y(s.page+1))},"下一页",8,pt),t("label",bt,[e[43]||(e[43]=t("span",null,"每页",-1)),t("select",{class:"input",value:s.pageSize,onChange:e[15]||(e[15]=l=>be(l))},[(d(),u(M,null,$(ne,l=>t("option",{key:l,value:l},o(l),9,ft)),64))],40,_t)]),t("span",null,"共 "+o(D.value)+" 条",1)]),g.value?(d(),u("p",ht,o(g.value),1)):z.value?(d(),u("p",gt,o(z.value),1)):V("",!0),U.value?(d(),u("div",mt,[t("div",yt,[t("header",null,[t("h2",null,"审核订单 "+o((a=m.value)==null?void 0:a.order_id),1)]),t("section",kt,[t("div",wt,[t("button",{type:"button",class:E(["btn",{"is-active":f.value==="approve"}]),onClick:e[16]||(e[16]=l=>f.value="approve")},"通过",2),t("button",{type:"button",class:E(["btn btn--danger",{"is-active":f.value==="reject"}]),onClick:e[17]||(e[17]=l=>f.value="reject")},"驳回",2)]),t("label",Ct,[e[44]||(e[44]=t("span",null,"备注",-1)),_(t("textarea",{class:"textarea","onUpdate:modelValue":e[18]||(e[18]=l=>w.value=l),rows:"4",placeholder:"请输入审核备注（至少 5 个字符）"},null,512),[[y,w.value,void 0,{trim:!0}]])])]),t("footer",St,[t("button",{type:"button",class:"btn btn--ghost",onClick:J},"取消"),t("button",{type:"button",class:"btn",disabled:!ae.value,onClick:me},"提交",8,xt)])])])):V("",!0),j.value?(d(),u("div",It,[t("div",Mt,[t("header",null,[t("h2",null,"批量"+o(C.value==="approve"?"通过":"驳回")+" "+o(h.value.length)+" 条订单",1)]),t("section",$t,[e[46]||(e[46]=t("p",{class:"modal__hint"},"将处理以下订单（最多展示前 3 条）：",-1)),t("ul",zt,[(d(!0),u(M,null,$(h.value.slice(0,3),l=>(d(),u("li",{key:l},o(l),1))),128)),h.value.length>3?(d(),u("li",Ot,"... 等 "+o(h.value.length)+" 条",1)):V("",!0)]),t("label",Vt,[e[45]||(e[45]=t("span",null,"备注",-1)),_(t("textarea",{class:"textarea","onUpdate:modelValue":e[19]||(e[19]=l=>S.value=l),rows:"4",placeholder:"请输入批量审核备注（至少 5 个字符）"},null,512),[[y,S.value,void 0,{trim:!0}]])])]),t("footer",Dt,[t("button",{type:"button",class:"btn btn--ghost",onClick:W},"取消"),t("button",{type:"button",class:E(["btn",{"btn--danger":C.value==="reject"}]),disabled:!ue.value,onClick:ye}," 确认提交 ",10,Nt)])])])):V("",!0)])}}}),Pt=Me(Ft,[["__scopeId","data-v-aa08fbf3"]]);export{Pt as default};
