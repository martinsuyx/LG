import{d as $,r as v,o as L,b as o,e,f as _,t as n,g as P,x as q,F as b,h as k,i as A,v as J,n as U,p as Y,q as u,_ as G}from"./index-DvtP9USg.js";import{O}from"./OrdersService-Bk90CBYk.js";import"./request-Bu45iIRO.js";const H={class:"detail"},K={class:"detail__head"},Q={class:"detail__title"},W={key:0,class:"detail__actions"},X=["data-status"],Z=["disabled"],ee=["disabled"],te={key:0,class:"placeholder"},le={key:1,class:"feedback feedback--error"},se={key:2,class:"detail__grid"},ne={class:"card"},ae={class:"card"},oe={class:"card"},ue={key:0,class:"materials"},de={class:"material-card__meta"},re={class:"material-card__type"},ie=["href"],ve={key:0,class:"material-card__ocr"},ce={key:1,class:"placeholder"},_e={class:"card"},pe={key:0,class:"risk-list"},me={class:"risk-item__level"},fe={key:1,class:"placeholder"},ye={class:"card card--wide"},be={key:0,class:"audit"},ke={class:"audit__time"},ge={class:"audit__actor"},he={class:"audit__action"},we={key:1,class:"placeholder"},Ce={key:3,class:"feedback"},De={key:4,class:"modal"},Ne={class:"modal__body"},Fe={class:"modal__content"},Me={class:"modal__field"},xe={class:"modal__footer"},Oe=["disabled"],Ie=$({__name:"OrderDetailPage",setup(Re){const g=q(),I=Y(),l=v(null),d=v(!1),r=v(""),p=v(""),m=v(!1),c=v("approve"),i=v(""),R={pending:"待提交",auto_reject:"自动拒绝",under_review:"待审核",approved:"已通过",rejected:"已驳回",settled:"已结算"},z=new Intl.NumberFormat("zh-CN",{style:"currency",currency:"CNY",minimumFractionDigits:2}),j=new Intl.DateTimeFormat("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});function h(s){return s?R[s]||s:"-"}function f(s){return s==null?"-":z.format(s)}function y(s){if(!s)return"-";try{return j.format(new Date(s))}catch{return s}}function B(s){return JSON.stringify(s,null,2)}function E(){I.back()}function w(s){c.value=s,i.value="",m.value=!0}function C(){m.value=!1,i.value=""}async function S(){if(!(!l.value||i.value.length<5)){d.value=!0,r.value="";try{const s={action:c.value,note:i.value,reviewer_id:"demo-reviewer"},t=await O.reviewOrder(l.value.order_id,s);l.value={...l.value,status:t.new_status??l.value.status},p.value=`订单已${c.value==="approve"?"通过":"驳回"}。`,C()}catch(s){r.value=(s==null?void 0:s.message)||"提交审核失败，请稍后再试。"}finally{d.value=!1}}}function T(s){return s?s.includes("Failed to fetch")||s.includes("NetworkError")?"无法连接到订单详情接口，请确认 Mock 服务已启动或网络可用。":s:"加载订单详情失败，请稍后再试。"}async function V(){const s=g.params.orderId;if(!s){r.value="缺少订单号。";return}d.value=!0,r.value="";try{l.value=await O.getOrderDetail(s)}catch(t){r.value=T(t==null?void 0:t.message)}finally{d.value=!1}}return L(()=>{V()}),(s,t)=>{var D,N,F,M,x;return u(),o("section",H,[e("header",K,[e("div",null,[e("button",{type:"button",class:"link-btn",onClick:E},"返回列表"),e("h1",Q,"订单 "+n(((D=l.value)==null?void 0:D.order_id)||P(g).params.orderId),1),t[3]||(t[3]=e("p",{class:"detail__subtitle"},"查看订单材料、结算与流转日志，并执行复核操作。",-1))]),l.value?(u(),o("div",W,[e("span",{class:"status-tag","data-status":l.value.status},n(h(l.value.status)),9,X),e("button",{type:"button",class:"btn",onClick:t[0]||(t[0]=a=>w("approve")),disabled:d.value},"通过",8,Z),e("button",{type:"button",class:"btn btn--danger",onClick:t[1]||(t[1]=a=>w("reject")),disabled:d.value},"驳回",8,ee)])):_("",!0)]),d.value?(u(),o("div",te,"加载中...")):r.value?(u(),o("div",le,n(r.value),1)):l.value?(u(),o("div",se,[e("section",ne,[t[13]||(t[13]=e("h2",null,"基本信息",-1)),e("dl",null,[e("div",null,[t[4]||(t[4]=e("dt",null,"订单号",-1)),e("dd",null,n(l.value.order_id),1)]),e("div",null,[t[5]||(t[5]=e("dt",null,"下单时间",-1)),e("dd",null,n(y(l.value.created_at)),1)]),e("div",null,[t[6]||(t[6]=e("dt",null,"状态",-1)),e("dd",null,n(h(l.value.status)),1)]),e("div",null,[t[7]||(t[7]=e("dt",null,"渠道",-1)),e("dd",null,n(l.value.channel),1)]),e("div",null,[t[8]||(t[8]=e("dt",null,"门店",-1)),e("dd",null,n(l.value.store_id||"-"),1)]),e("div",null,[t[9]||(t[9]=e("dt",null,"活动",-1)),e("dd",null,n(l.value.campaign_id||"-"),1)]),e("div",null,[t[10]||(t[10]=e("dt",null,"金额",-1)),e("dd",null,n(f(l.value.amount)),1)]),e("div",null,[t[11]||(t[11]=e("dt",null,"冻结金额",-1)),e("dd",null,n(l.value.frozen_amount!==void 0?f(l.value.frozen_amount):"-"),1)]),e("div",null,[t[12]||(t[12]=e("dt",null,"实际入账",-1)),e("dd",null,n(l.value.settled_amount!==null&&l.value.settled_amount!==void 0?f(l.value.settled_amount):"-"),1)])])]),e("section",ae,[t[17]||(t[17]=e("h2",null,"用户信息",-1)),e("dl",null,[e("div",null,[t[14]||(t[14]=e("dt",null,"用户",-1)),e("dd",null,n(((N=l.value.user)==null?void 0:N.name)||"-"),1)]),e("div",null,[t[15]||(t[15]=e("dt",null,"手机号",-1)),e("dd",null,n(((F=l.value.user)==null?void 0:F.phone)||"-"),1)]),e("div",null,[t[16]||(t[16]=e("dt",null,"证件号",-1)),e("dd",null,n(((M=l.value.user)==null?void 0:M.id_number)||"-"),1)])])]),e("section",oe,[t[18]||(t[18]=e("h2",null,"上传材料",-1)),l.value.materials&&l.value.materials.length?(u(),o("div",ue,[(u(!0),o(b,null,k(l.value.materials,a=>(u(),o("article",{key:a.url,class:"material-card"},[e("div",de,[e("span",re,n(a.type),1),e("span",null,n(y(a.uploaded_at)),1)]),e("a",{class:"link-btn",href:a.url,target:"_blank",rel:"noreferrer"},"查看原图",8,ie),a.ocr?(u(),o("pre",ve,n(B(a.ocr)),1)):_("",!0)]))),128))])):(u(),o("p",ce,"暂无材料"))]),e("section",_e,[t[19]||(t[19]=e("h2",null,"风控命中",-1)),l.value.risk_hits&&l.value.risk_hits.length?(u(),o("div",pe,[(u(!0),o(b,null,k(l.value.risk_hits,a=>(u(),o("article",{key:a.rule_id,class:"risk-item"},[e("strong",null,n(a.rule_name),1),e("span",me,n(a.level),1),e("p",null,n(a.desc),1)]))),128))])):(u(),o("p",fe,"未命中风控规则"))]),e("section",ye,[t[20]||(t[20]=e("h2",null,"流转日志",-1)),l.value.audits&&l.value.audits.length?(u(),o("ul",be,[(u(!0),o(b,null,k(l.value.audits,a=>(u(),o("li",{key:a.time},[e("span",ke,n(y(a.time)),1),e("span",ge,n(a.actor),1),e("span",he,n(a.action),1),e("span",null,n(a.note||"-"),1)]))),128))])):(u(),o("p",we,"暂无日志"))])])):_("",!0),p.value?(u(),o("p",Ce,n(p.value),1)):_("",!0),m.value?(u(),o("div",De,[e("div",Ne,[e("header",null,[e("h2",null,n(c.value==="approve"?"通过订单":"驳回订单"),1)]),e("section",Fe,[e("p",null,"订单号："+n((x=l.value)==null?void 0:x.order_id),1),e("label",Me,[t[21]||(t[21]=e("span",null,"备注（至少 5 个字符）",-1)),A(e("textarea",{class:"textarea","onUpdate:modelValue":t[2]||(t[2]=a=>i.value=a),rows:"4",placeholder:"请输入备注"},null,512),[[J,i.value,void 0,{trim:!0}]])])]),e("footer",xe,[e("button",{type:"button",class:"btn btn--ghost",onClick:C},"取消"),e("button",{type:"button",class:U(["btn",{"btn--danger":c.value==="reject"}]),disabled:i.value.length<5||d.value,onClick:S}," 确认提交 ",10,Oe)])])])):_("",!0)])}}}),Ee=G(Ie,[["__scopeId","data-v-6d5b37fd"]]);export{Ee as default};
