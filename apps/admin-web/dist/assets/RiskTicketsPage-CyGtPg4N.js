import{d as be,r as T,a as S,c as R,o as we,b as o,e as t,f as C,A as c,B as n,t as l,i as D,j as se,F as N,h as E,v as B,k as G,q as r,s as d,_ as Te}from"./index-DvtP9USg.js";import{B as k}from"./Button-BaguUGDy.js";import{M as ie}from"./Modal-CtEdl0zk.js";import{T as Ce}from"./Table-BsZuLW91.js";import{a as P}from"./risk-DnqpjeeB.js";const Me={class:"risk-tickets"},Ve={class:"risk-tickets__header"},$e={class:"risk-tickets__actions"},De={key:0,class:"risk-tickets__summary","aria-label":"工单统计"},xe={class:"summary-card"},Ue={class:"summary-card"},Le={class:"summary-card summary-card--critical"},he=["disabled"],Ne=["value"],Ee=["disabled"],je=["value"],ze={class:"filters__keyword"},Ae=["disabled"],Fe={class:"filters__actions"},Oe={class:"risk-tickets__layout"},Se={class:"tickets-table",role:"region","aria-label":"工单列表"},Re=["data-level"],Be=["data-status"],Pe={key:1},Ie={key:0,class:"tickets-drawer"},Ke={class:"drawer__header"},Ge={key:0,class:"drawer__body"},qe={key:1,class:"drawer__body"},He={class:"drawer-section"},Qe={class:"drawer-grid"},Ye=["data-status"],Je=["data-level"],We={key:0,class:"drawer-section"},Xe={class:"drawer-text"},Ze={key:1,class:"drawer-section"},et={class:"entity-list"},tt={class:"entity-type"},st={key:2,class:"drawer-section"},it={class:"action-timeline"},lt={class:"timeline-time"},at={class:"timeline-action"},nt={key:0,class:"timeline-note"},ot={class:"drawer-actions"},rt={key:2,class:"drawer__body"},ut={key:1,class:"feedback"},dt={key:2,class:"feedback feedback--error"},ct=be({__name:"RiskTicketsPage",setup(vt){const j=[{ticket_id:"K20251003001",created_at:"2025-10-03T09:10:00+08:00",priority:"high",status:"investigating",severity:"high",assignee_id:"U2001",assignee_name:"林杉",source:"hit",rule_id:"GEOFENCE_OUT",title:"越界地理围栏(高) O20251003001",due_at:"2025-10-03T10:10:00+08:00",sla_minutes:60,tags:["地理围栏","高风险"]},{ticket_id:"K20251003005",created_at:"2025-10-03T08:45:00+08:00",priority:"normal",status:"assigned",severity:"medium",assignee_id:"U2002",assignee_name:"朱敏",source:"hit",rule_id:"FREQ_APPLY",title:"短期高频提交 O20251002999",due_at:"2025-10-03T11:45:00+08:00",sla_minutes:180,tags:["频率","人工"]}],V={K20251003001:{...j[0],updated_at:"2025-10-03T09:18:00+08:00",creator_id:"U1900",creator_name:"风控机器人",desc:"位置与门店距离超过 10km，疑似代办。",hit_ids:["H202510030001"],order_ids:["O20251003001"],entities:[{type:"device",id:"DEV-9A7",label:"设备"},{type:"phone",id:"138****0000",label:"手机号"}],actions:[{time:"2025-10-03T09:11:00+08:00",actor:"系统",action:"create",note:"命中 GEOFENCE_OUT 规则"},{time:"2025-10-03T09:12:00+08:00",actor:"林杉",action:"assign",note:"指派给自己",to_status:"assigned"},{time:"2025-10-03T09:13:30+08:00",actor:"林杉",action:"start",note:"开始调查",to_status:"investigating"}],attachments:[{name:"location-map.png",url:"/mock/location-map.png",uploaded_by:"林杉",uploaded_at:"2025-10-03T09:14:00+08:00"}],overdue:!1}},v=T([]),b=T(!1),I=T(!1),g=T(null),y=S({}),m=S({status:"",priority:"",keyword:""}),le=[{value:"new",label:"新建"},{value:"assigned",label:"已指派"},{value:"investigating",label:"调查中"},{value:"pending_info",label:"待补资料"},{value:"resolved",label:"已处置"},{value:"rejected",label:"已拒绝"},{value:"closed",label:"已关闭"}],ae=[{value:"low",label:"低"},{value:"normal",label:"普通"},{value:"high",label:"高"},{value:"critical",label:"致命"}],ne=[{key:"ticket_id",title:"工单号",width:"9rem",sortable:!0},{key:"title",title:"标题"},{key:"priority",title:"优先级",width:"6rem"},{key:"status",title:"状态",width:"7rem"},{key:"assignee_name",title:"负责人",width:"7rem"},{key:"created_at",title:"创建时间",width:"10rem",sortable:!0},{key:"due_at",title:"到期时间",width:"10rem"},{key:"tags",title:"标签",width:"10rem"}],M=R(()=>v.value.find(s=>s.ticket_id===g.value)||null),u=R(()=>g.value&&y[g.value]||null),oe=R(()=>v.value.filter(s=>s.status==="investigating"||s.status==="assigned").length),re=R(()=>v.value.filter(s=>s.due_at&&new Date(s.due_at).getTime()<Date.now()).length),x=T(""),$=T(""),w=T(!1),U=T(!1),f=S({assignee_id:"",note:""}),_=S({visible:!1,action:"",title:"",note:""});we(()=>{q()});async function q(){b.value=!0;try{const s=await P.listTickets(),e=Array.isArray(s==null?void 0:s.items)?s.items:[];v.value=e.length?e:j}catch(s){v.value=j,h(s.message||"加载工单失败")}finally{b.value=!1}}function H(){let s=[...j];if(m.status&&(s=s.filter(e=>e.status===m.status)),m.priority&&(s=s.filter(e=>e.priority===m.priority)),m.keyword){const e=m.keyword.toLowerCase();s=s.filter(a=>`${a.ticket_id}${a.title}${a.assignee_name??""}`.toLowerCase().includes(e))}v.value=s}function ue(){m.status="",m.priority="",m.keyword="",H()}async function de(s){if(g.value=s.ticket_id,!y[s.ticket_id]){I.value=!0;try{const e=await P.getTicketDetail(s.ticket_id);e?y[s.ticket_id]=e:V[s.ticket_id]&&(y[s.ticket_id]=V[s.ticket_id])}catch(e){V[s.ticket_id]?y[s.ticket_id]=V[s.ticket_id]:h(e.message||"加载工单详情失败")}finally{I.value=!1}}}function ce(){g.value=null}function ve(){g.value&&(f.assignee_id=(M==null?void 0:M.assignee_id)||"",f.note="",U.value=!0)}function me(){z("pend","标记待补资料")}function _e(){z("resolve","标记已处置")}function fe(){z("reject","拒绝工单")}function pe(){z("close","关闭工单")}function z(s,e){g.value&&(_.visible=!0,_.action=s,_.title=e,_.note="")}function Q(){_.visible=!1,_.action="",_.note=""}async function Y(){if(!g.value||!f.assignee_id.trim()){h("请填写负责人 ID");return}const s=g.value,e=X(s);A(s,{assignee_id:f.assignee_id.trim(),assignee_name:f.assignee_id.trim(),status:"assigned"}),w.value=!0;try{const a=await P.transition(s,"assign",{assignee_id:f.assignee_id.trim(),note:f.note||void 0});A(s,{status:a.new_status,assignee_id:a.assignee_id||f.assignee_id.trim(),assignee_name:a.assignee_name||f.assignee_id.trim()}),te("指派成功"),U.value=!1}catch(a){Z(s,e),h(a.message||"指派失败")}finally{w.value=!1}}async function ke(){await W("start","已进入调查","investigating")}async function J(){if(!_.action)return;const e={pend:{action:"pend",success:"已标记待补资料",status:"pending_info"},resolve:{action:"resolve",success:"工单已处置",status:"resolved"},reject:{action:"reject",success:"工单已拒绝",status:"rejected"},close:{action:"close",success:"工单已关闭",status:"closed"}}[_.action];await W(e.action,e.success,e.status,_.note||void 0),Q()}async function W(s,e,a,p){if(!g.value)return;const i=g.value,F=X(i);A(i,{status:a}),w.value=!0;try{await P.transition(i,s,p?{note:p}:void 0),A(i,{status:a}),te(e)}catch(O){Z(i,F),h(O.message||"操作失败")}finally{w.value=!1}}function X(s){const e=v.value.find(p=>p.ticket_id===s),a=y[s];return{listItem:e?{...e}:null,detail:a?{...a}:null}}function A(s,e){const a=v.value.findIndex(p=>p.ticket_id===s);a>=0&&v.value.splice(a,1,{...v.value[a],...e}),y[s]?y[s]={...y[s],...e}:V[s]&&(y[s]={...V[s],...e})}function Z(s,e){if(e.listItem){const a=v.value.findIndex(p=>p.ticket_id===s);a>=0&&v.value.splice(a,1,e.listItem)}e.detail&&(y[s]=e.detail)}function ee(s){switch(s){case"low":return"低";case"normal":return"普通";case"high":return"高";case"critical":return"致命";default:return s}}function K(s){switch(s){case"new":return"新建";case"assigned":return"已指派";case"investigating":return"调查中";case"pending_info":return"待补资料";case"resolved":return"已处置";case"rejected":return"已拒绝";case"closed":return"已关闭";default:return s}}function ge(s,e){const a={create:"创建工单",assign:"指派",start:"开始调查",pend:"待补资料",resolve:"标记处理",reject:"拒绝",close:"关闭"},p=e?` → ${K(e)}`:"";return`${a[s]||s}${p}`}function ye(s){return s==="hit"?"命中转单":"手工创建"}function L(s){if(!s)return"—";const e=new Date(s);return Number.isNaN(e.getTime())?s:`${e.toLocaleDateString()} ${e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}`}function te(s){x.value=s,$.value="",window.setTimeout(()=>{x.value===s&&(x.value="")},4e3)}function h(s){$.value=s,window.setTimeout(()=>{$.value===s&&($.value="")},5e3)}return(s,e)=>{var a,p;return r(),o("section",Me,[t("header",Ve,[e[12]||(e[12]=t("div",null,[t("h1",{class:"risk-tickets__title"},"风控工单"),t("p",{class:"risk-tickets__subtitle"},"跟踪风险案件的分配与处置进度。")],-1)),t("div",$e,[c(k,{size:"sm",variant:"ghost",disabled:b.value,onClick:q},{default:n(()=>[...e[11]||(e[11]=[d("刷新",-1)])]),_:1},8,["disabled"])])]),v.value.length?(r(),o("section",De,[t("article",xe,[e[13]||(e[13]=t("h3",null,"全部",-1)),t("strong",null,l(v.value.length),1)]),t("article",Ue,[e[14]||(e[14]=t("h3",null,"进行中",-1)),t("strong",null,l(oe.value),1)]),t("article",Le,[e[15]||(e[15]=t("h3",null,"超时",-1)),t("strong",null,l(re.value),1)])])):C("",!0),t("form",{class:"risk-tickets__filters",onSubmit:G(H,["prevent"])},[t("label",null,[e[17]||(e[17]=t("span",null,"状态",-1)),D(t("select",{"onUpdate:modelValue":e[0]||(e[0]=i=>m.status=i),disabled:b.value},[e[16]||(e[16]=t("option",{value:""},"全部",-1)),(r(),o(N,null,E(le,i=>t("option",{key:i.value,value:i.value},l(i.label),9,Ne)),64))],8,he),[[se,m.status]])]),t("label",null,[e[19]||(e[19]=t("span",null,"优先级",-1)),D(t("select",{"onUpdate:modelValue":e[1]||(e[1]=i=>m.priority=i),disabled:b.value},[e[18]||(e[18]=t("option",{value:""},"全部",-1)),(r(),o(N,null,E(ae,i=>t("option",{key:i.value,value:i.value},l(i.label),9,je)),64))],8,Ee),[[se,m.priority]])]),t("label",ze,[e[20]||(e[20]=t("span",null,"关键词",-1)),D(t("input",{type:"search","onUpdate:modelValue":e[2]||(e[2]=i=>m.keyword=i),placeholder:"工单号 / 标题 / 负责人",disabled:b.value},null,8,Ae),[[B,m.keyword,void 0,{trim:!0}]])]),t("div",Fe,[c(k,{size:"sm",type:"submit",loading:b.value},{default:n(()=>[...e[21]||(e[21]=[d("应用",-1)])]),_:1},8,["loading"]),c(k,{size:"sm",variant:"ghost",type:"button",onClick:ue,disabled:b.value},{default:n(()=>[...e[22]||(e[22]=[d("重置",-1)])]),_:1},8,["disabled"])])],32),t("div",Oe,[t("section",Se,[c(Ce,{columns:ne,rows:v.value,loading:b.value,"row-key":i=>i.ticket_id,"default-sort-key":"created_at","default-sort-order":"desc",onRowClick:de},{"cell:priority":n(({row:i})=>[t("span",{class:"priority-chip","data-level":i.priority},l(ee(i.priority)),9,Re)]),"cell:status":n(({row:i})=>[t("span",{class:"status-chip","data-status":i.status},l(K(i.status)),9,Be)]),"cell:created_at":n(({row:i})=>[d(l(L(i.created_at)),1)]),"cell:due_at":n(({row:i})=>[d(l(L(i.due_at)),1)]),"cell:tags":n(({row:i})=>{var F;return[(F=i.tags)!=null&&F.length?(r(!0),o(N,{key:0},E(i.tags,O=>(r(),o("span",{key:`${i.ticket_id}-${O}`,class:"tag-chip"},l(O),1))),128)):(r(),o("span",Pe,"—"))]}),empty:n(()=>[d(l(b.value?"加载中…":"暂无工单"),1)]),_:1},8,["rows","loading","row-key"])]),M.value?(r(),o("aside",Ie,[t("header",Ke,[t("div",null,[t("h2",null,l(M.value.title),1),t("p",null,l(M.value.ticket_id)+" · "+l(L(M.value.created_at)),1)]),t("button",{type:"button",class:"drawer__close","aria-label":"关闭",onClick:ce},"×")]),I.value?(r(),o("div",Ge,[...e[23]||(e[23]=[t("p",{class:"drawer__placeholder"},"详情加载中…",-1)])])):u.value?(r(),o("div",qe,[t("section",He,[e[30]||(e[30]=t("h3",null,"基本信息",-1)),t("dl",Qe,[t("div",null,[e[24]||(e[24]=t("dt",null,"状态",-1)),t("dd",null,[t("span",{class:"status-chip","data-status":u.value.status},l(K(u.value.status)),9,Ye)])]),t("div",null,[e[25]||(e[25]=t("dt",null,"优先级",-1)),t("dd",null,[t("span",{class:"priority-chip","data-level":u.value.priority},l(ee(u.value.priority)),9,Je)])]),t("div",null,[e[26]||(e[26]=t("dt",null,"负责人",-1)),t("dd",null,l(u.value.assignee_name||"未指派"),1)]),t("div",null,[e[27]||(e[27]=t("dt",null,"来源",-1)),t("dd",null,l(ye(u.value.source)),1)]),t("div",null,[e[28]||(e[28]=t("dt",null,"SLA",-1)),t("dd",null,l(u.value.sla_minutes?`${u.value.sla_minutes} 分钟`:"—"),1)]),t("div",null,[e[29]||(e[29]=t("dt",null,"到期时间",-1)),t("dd",null,l(L(u.value.due_at)),1)])])]),u.value.desc?(r(),o("section",We,[e[31]||(e[31]=t("h3",null,"说明",-1)),t("p",Xe,l(u.value.desc),1)])):C("",!0),(a=u.value.entities)!=null&&a.length?(r(),o("section",Ze,[e[32]||(e[32]=t("h3",null,"关联主体",-1)),t("ul",et,[(r(!0),o(N,null,E(u.value.entities,i=>(r(),o("li",{key:`${u.value.ticket_id}-${i.type}-${i.id}`},[t("span",tt,l(i.label||i.type),1),t("span",null,l(i.id),1)]))),128))])])):C("",!0),(p=u.value.actions)!=null&&p.length?(r(),o("section",st,[e[33]||(e[33]=t("h3",null,"处理记录",-1)),t("ul",it,[(r(!0),o(N,null,E(u.value.actions,i=>(r(),o("li",{key:`${u.value.ticket_id}-${i.time}-${i.action}`},[t("span",lt,l(L(i.time)),1),t("div",null,[t("strong",null,l(i.actor),1),t("span",at,l(ge(i.action,i.to_status)),1),i.note?(r(),o("span",nt,l(i.note),1)):C("",!0)])]))),128))])])):C("",!0),t("div",ot,[c(k,{size:"sm",variant:"secondary",onClick:ve},{default:n(()=>[...e[34]||(e[34]=[d("指派",-1)])]),_:1}),c(k,{size:"sm",variant:"secondary",onClick:ke},{default:n(()=>[...e[35]||(e[35]=[d("开始调查",-1)])]),_:1}),c(k,{size:"sm",variant:"secondary",onClick:me},{default:n(()=>[...e[36]||(e[36]=[d("待补资料",-1)])]),_:1}),c(k,{size:"sm",variant:"primary",onClick:_e},{default:n(()=>[...e[37]||(e[37]=[d("标记已处置",-1)])]),_:1}),c(k,{size:"sm",variant:"danger",onClick:fe},{default:n(()=>[...e[38]||(e[38]=[d("拒绝",-1)])]),_:1}),c(k,{size:"sm",variant:"ghost",onClick:pe},{default:n(()=>[...e[39]||(e[39]=[d("关闭",-1)])]),_:1})])])):(r(),o("div",rt,[...e[40]||(e[40]=[t("p",{class:"drawer__placeholder"},"请选择工单查看详情",-1)])]))])):C("",!0)]),x.value?(r(),o("p",ut,l(x.value),1)):C("",!0),$.value?(r(),o("p",dt,l($.value),1)):C("",!0),c(ie,{modelValue:U.value,"onUpdate:modelValue":e[7]||(e[7]=i=>U.value=i),onConfirm:Y},{title:n(()=>[...e[41]||(e[41]=[d("指派工单",-1)])]),footer:n(()=>[c(k,{variant:"secondary",onClick:e[6]||(e[6]=i=>U.value=!1),disabled:w.value},{default:n(()=>[...e[44]||(e[44]=[d("取消",-1)])]),_:1},8,["disabled"]),c(k,{variant:"primary",loading:w.value,onClick:Y},{default:n(()=>[...e[45]||(e[45]=[d("确认",-1)])]),_:1},8,["loading"])]),default:n(()=>[t("form",{class:"modal-form",onSubmit:e[5]||(e[5]=G(()=>{},["prevent"]))},[t("label",null,[e[42]||(e[42]=t("span",null,"负责人 ID",-1)),D(t("input",{type:"text","onUpdate:modelValue":e[3]||(e[3]=i=>f.assignee_id=i),placeholder:"如 U2099"},null,512),[[B,f.assignee_id,void 0,{trim:!0}]])]),t("label",null,[e[43]||(e[43]=t("span",null,"备注",-1)),D(t("textarea",{rows:"3","onUpdate:modelValue":e[4]||(e[4]=i=>f.note=i),placeholder:"可选"},null,512),[[B,f.note,void 0,{trim:!0}]])])],32)]),_:1},8,["modelValue"]),c(ie,{modelValue:_.visible,"onUpdate:modelValue":e[10]||(e[10]=i=>_.visible=i),onConfirm:J},{title:n(()=>[d(l(_.title),1)]),footer:n(()=>[c(k,{variant:"secondary",onClick:Q,disabled:w.value},{default:n(()=>[...e[47]||(e[47]=[d("取消",-1)])]),_:1},8,["disabled"]),c(k,{variant:"primary",loading:w.value,onClick:J},{default:n(()=>[...e[48]||(e[48]=[d("确认",-1)])]),_:1},8,["loading"])]),default:n(()=>[t("form",{class:"modal-form",onSubmit:e[9]||(e[9]=G(()=>{},["prevent"]))},[t("label",null,[e[46]||(e[46]=t("span",null,"备注",-1)),D(t("textarea",{rows:"3","onUpdate:modelValue":e[8]||(e[8]=i=>_.note=i),placeholder:"请输入备注"},null,512),[[B,_.note,void 0,{trim:!0}]])])],32)]),_:1},8,["modelValue"])])}}}),gt=Te(ct,[["__scopeId","data-v-e936f8da"]]);export{gt as default};
