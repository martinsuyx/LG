import{O as V,d as kt,a as lt,r as u,c as K,o as St,b as o,e as t,f as S,i as w,v as M,j as Q,F as y,h as k,t as n,k as X,n as Ct,q as i,_ as xt}from"./index-DvtP9USg.js";import{r as F}from"./request-Bu45iIRO.js";import{E as It}from"./ExportsService-BVSn6J7L.js";class z{static listWithdraws(p,_,C,W,a="platform",N,O=1,$=20){return F(V,{method:"GET",url:"/api/v1/withdraws",query:{start:p,end:_,status:C,channel:W,dimension:a,entity_id:N,page:O,page_size:$},errors:{400:"Invalid filters supplied."}})}static getWithdrawStats(p,_){return F(V,{method:"GET",url:"/api/v1/withdraws/stats",query:{start:p,end:_},errors:{400:"Invalid filters supplied."}})}static approveWithdraw(p,_){return F(V,{method:"POST",url:"/api/v1/withdraws/{withdraw_id}/approve",path:{withdraw_id:p},body:_,mediaType:"application/json",errors:{400:"Invalid request."}})}static rejectWithdraw(p,_){return F(V,{method:"POST",url:"/api/v1/withdraws/{withdraw_id}/reject",path:{withdraw_id:p},body:_,mediaType:"application/json",errors:{400:"Invalid request."}})}}const Mt={class:"withdraws"},zt={class:"withdraws__head"},Wt={class:"withdraws__actions"},jt=["disabled"],Dt={class:"filters__group"},Et={class:"filters__row"},Tt={class:"filters__field"},Vt={class:"filters__field"},Ft={class:"filters__field"},Nt=["value"],Ot={class:"filters__field"},$t=["value"],Pt={class:"filters__field"},Ut=["value"],Bt={class:"filters__field"},qt={class:"filters__actions"},At=["disabled"],Lt=["disabled"],Gt={class:"stats"},Rt={class:"stat-card"},Yt={class:"stat-card__value"},Ht={class:"stat-card"},Jt={class:"stat-card__value"},Kt={class:"stat-card"},Qt={class:"stat-card__value"},Xt={key:0,class:"batch-bar"},Zt={class:"batch-bar__actions"},te={class:"table-card"},ee={class:"col-checkbox"},se=["checked"],le={key:0},ae={key:1},ne={class:"col-checkbox"},oe=["checked","onChange"],ie=["data-status"],de={class:"actions-col"},ue={class:"row-actions"},re=["onClick","disabled"],ce=["onClick","disabled"],ve={key:2},pe={class:"pager"},_e=["disabled"],he=["disabled"],be={class:"pager__size"},fe=["value"],me=["value"],ge={key:1,class:"feedback feedback--error"},we={key:2,class:"feedback"},ye={class:"modal__body"},ke={class:"modal__content"},Se={key:0},Ce={class:"modal__field"},xe={class:"modal__footer"},Ie=["disabled"],Me={class:"modal__body"},ze={class:"modal__content"},We={class:"modal__list"},je={key:0},De={class:"modal__field"},Ee={class:"modal__footer"},Te=["disabled"],Ve=kt({__name:"WithdrawsPage",setup(at){const p=new Date,_=p.toISOString().slice(0,10),C=new Date(p);C.setDate(C.getDate()-6);const W=C.toISOString().slice(0,10),a=lt({start:W,end:_,status:[],channel:[],dimension:"platform",entityId:"",page:1,pageSize:20}),N=["pending","processing","succeeded","failed","rejected"],O=["bank","alipay","wechat"],$=[{value:"platform",label:"平台"},{value:"company",label:"公司"},{value:"team",label:"团队"},{value:"store",label:"门店"},{value:"promoter",label:"推广人"},{value:"individual",label:"个人"}],nt=[20,50,100,200],j=u(null),v=u([]),D=u(0),b=u(!1),h=u(""),f=u(""),c=lt(new Set),m=K(()=>Array.from(c)),ot=K(()=>v.value.length>0&&v.value.every(l=>c.has(l.withdraw_id))),P=u(!1),r=u(null),x=u("approve"),g=u(""),U=u(!1),B=u(!1),I=u(""),q=u(!1),it=new Intl.NumberFormat("zh-CN",{style:"currency",currency:"CNY",minimumFractionDigits:2}),dt=new Intl.DateTimeFormat("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});function E(l){return l==null?"-":it.format(l)}function ut(l){if(!l)return"-";try{return dt.format(new Date(l))}catch{return l}}function rt(l){switch(l){case"pending":return"待审核";case"processing":return"出款中";case"succeeded":return"已出款";case"failed":return"失败";case"rejected":return"已驳回";default:return l}}function T(l,e="加载提现列表失败，请稍后再试。"){return l?l.includes("Failed to fetch")||l.includes("NetworkError")?"无法连接到提现接口，请确认 Mock 服务已启动或网络可用。":l:e}function ct(){a.start=W,a.end=_,a.status=[],a.channel=[],a.dimension="platform",a.entityId="",a.page=1,a.pageSize=20,H()}function vt(){a.page=1,H()}function Z(l){const e=Math.min(Math.max(l,1),A.value);a.page!==e&&(a.page=e,Y())}function pt(l){const e=Number(l.target.value);a.pageSize!==e&&(a.pageSize=e,a.page=1,Y())}const A=K(()=>Math.max(1,Math.ceil(D.value/a.pageSize)));function _t(l,e){e.target.checked?c.add(l):c.delete(l)}function ht(l){l.target.checked?v.value.forEach(d=>c.add(d.withdraw_id)):v.value.forEach(d=>c.delete(d.withdraw_id))}function bt(){c.clear()}function tt(l,e){r.value=l,x.value=e,g.value="",P.value=!0}function L(){P.value=!1,r.value=null,g.value=""}function ft(l){I.value="",B.value=!0}function G(){B.value=!1}async function mt(){if(r.value){U.value=!0,h.value="";try{x.value==="approve"?(await z.approveWithdraw(r.value.withdraw_id,g.value?{note:g.value}:void 0),R(r.value.withdraw_id,"processing"),f.value=`提现 ${r.value.withdraw_id} 已通过，进入出款流程。`):(await z.rejectWithdraw(r.value.withdraw_id,{note:g.value}),R(r.value.withdraw_id,"rejected"),f.value=`提现 ${r.value.withdraw_id} 已驳回。`),c.delete(r.value.withdraw_id),L()}catch(l){h.value=T(l==null?void 0:l.message,"操作失败，请稍后再试。")}finally{U.value=!1}}}async function gt(){q.value=!0,h.value="";try{for(const l of m.value)await z.approveWithdraw(l,I.value?{note:I.value}:void 0),R(l,"processing");f.value=`批量通过 ${m.value.length} 条提现申请成功。`,c.clear(),G()}catch(l){h.value=T(l==null?void 0:l.message,"批量操作失败，请稍后再试。")}finally{q.value=!1}}function R(l,e){v.value=v.value.map(d=>d.withdraw_id===l?{...d,status:e}:d)}async function wt(){f.value="",h.value="";try{await It.exportWithdraws(),f.value="已创建导出任务，请前往导出中心查看。"}catch(l){h.value=T(l==null?void 0:l.message,"导出失败，请稍后再试。")}}async function yt(){j.value=await z.getWithdrawStats(a.start||void 0,a.end||void 0)}async function Y(){const l=await z.listWithdraws(a.start||void 0,a.end||void 0,a.status.length?a.status:void 0,a.channel.length?a.channel:void 0,a.dimension,a.entityId||void 0,a.page,a.pageSize);v.value=l.items??[],D.value=l.total??0;const e=new Set(v.value.map(d=>d.withdraw_id));Array.from(c).forEach(d=>{e.has(d)||c.delete(d)})}async function H(){b.value=!0,h.value="",f.value="";try{await Promise.all([yt(),Y()])}catch(l){h.value=T(l==null?void 0:l.message),v.value=[],D.value=0}finally{b.value=!1}}return St(()=>{H()}),(l,e)=>{var d,et,st;return i(),o("section",Mt,[t("header",zt,[e[13]||(e[13]=t("div",null,[t("h1",{class:"withdraws__title"},"提现管理"),t("p",{class:"withdraws__subtitle"},"审核与出款提现请求，跟踪状态与异常。")],-1)),t("div",Wt,[t("button",{type:"button",class:"btn",onClick:wt,disabled:b.value},"导出当前筛选",8,jt)])]),t("form",{class:"filters",onSubmit:X(vt,["prevent"])},[t("fieldset",Dt,[e[20]||(e[20]=t("legend",null,"筛选条件",-1)),t("div",Et,[t("label",Tt,[e[14]||(e[14]=t("span",null,"开始日期",-1)),w(t("input",{class:"input",type:"date","onUpdate:modelValue":e[0]||(e[0]=s=>a.start=s)},null,512),[[M,a.start]])]),t("label",Vt,[e[15]||(e[15]=t("span",null,"结束日期",-1)),w(t("input",{class:"input",type:"date","onUpdate:modelValue":e[1]||(e[1]=s=>a.end=s)},null,512),[[M,a.end]])]),t("label",Ft,[e[16]||(e[16]=t("span",null,"状态",-1)),w(t("select",{class:"input",multiple:"","onUpdate:modelValue":e[2]||(e[2]=s=>a.status=s)},[(i(),o(y,null,k(N,s=>t("option",{key:s,value:s},n(s),9,Nt)),64))],512),[[Q,a.status]])]),t("label",Ot,[e[17]||(e[17]=t("span",null,"渠道",-1)),w(t("select",{class:"input",multiple:"","onUpdate:modelValue":e[3]||(e[3]=s=>a.channel=s)},[(i(),o(y,null,k(O,s=>t("option",{key:s,value:s},n(s),9,$t)),64))],512),[[Q,a.channel]])]),t("label",Pt,[e[18]||(e[18]=t("span",null,"维度",-1)),w(t("select",{class:"input","onUpdate:modelValue":e[4]||(e[4]=s=>a.dimension=s)},[(i(),o(y,null,k($,s=>t("option",{key:s.value,value:s.value},n(s.label),9,Ut)),64))],512),[[Q,a.dimension]])]),t("label",Bt,[e[19]||(e[19]=t("span",null,"主体 ID",-1)),w(t("input",{class:"input",type:"text","onUpdate:modelValue":e[5]||(e[5]=s=>a.entityId=s),placeholder:"如 S001"},null,512),[[M,a.entityId,void 0,{trim:!0}]])])]),t("div",qt,[t("button",{type:"submit",class:"btn",disabled:b.value},"应用筛选",8,At),t("button",{type:"button",class:"btn btn--ghost",onClick:ct,disabled:b.value},"重置",8,Lt)])])],32),t("section",Gt,[t("article",Rt,[e[21]||(e[21]=t("span",{class:"stat-card__label"},"待处理总额",-1)),t("strong",Yt,n(E((d=j.value)==null?void 0:d.pending_total)),1)]),t("article",Ht,[e[22]||(e[22]=t("span",{class:"stat-card__label"},"今日已出款",-1)),t("strong",Jt,n(E((et=j.value)==null?void 0:et.paid_today)),1)]),t("article",Kt,[e[23]||(e[23]=t("span",{class:"stat-card__label"},"失败笔数",-1)),t("strong",Qt,n(((st=j.value)==null?void 0:st.failed_count)??0),1)])]),m.value.length?(i(),o("div",Xt,[t("span",null,"已选 "+n(m.value.length)+" 条",1),t("div",Zt,[t("button",{type:"button",class:"btn",onClick:e[6]||(e[6]=s=>ft())},"批量通过"),t("button",{type:"button",class:"btn btn--ghost",onClick:bt},"清空")])])):S("",!0),t("div",te,[t("table",null,[t("thead",null,[t("tr",null,[t("th",ee,[t("input",{type:"checkbox",checked:ot.value,onChange:e[7]||(e[7]=s=>ht(s))},null,40,se)]),e[24]||(e[24]=t("th",null,"申请号",-1)),e[25]||(e[25]=t("th",null,"时间",-1)),e[26]||(e[26]=t("th",null,"主体",-1)),e[27]||(e[27]=t("th",null,"金额",-1)),e[28]||(e[28]=t("th",null,"渠道",-1)),e[29]||(e[29]=t("th",null,"账号信息",-1)),e[30]||(e[30]=t("th",null,"状态",-1)),e[31]||(e[31]=t("th",null,"备注",-1)),e[32]||(e[32]=t("th",{class:"actions-col"},"操作",-1))])]),b.value?(i(),o("tbody",le,[(i(),o(y,null,k(5,s=>t("tr",{key:`loading-${s}`},[...e[33]||(e[33]=[t("td",{colspan:10},[t("div",{class:"skeleton"})],-1)])])),64))])):v.value.length?(i(),o("tbody",ae,[(i(!0),o(y,null,k(v.value,s=>(i(),o("tr",{key:s.withdraw_id},[t("td",ne,[t("input",{type:"checkbox",checked:c.has(s.withdraw_id),onChange:J=>_t(s.withdraw_id,J)},null,40,oe)]),t("td",null,n(s.withdraw_id),1),t("td",null,n(ut(s.created_at)),1),t("td",null,n(s.entity_name),1),t("td",null,n(E(s.amount)),1),t("td",null,n(s.channel),1),t("td",null,n(s.account_info),1),t("td",null,[t("span",{class:"status-tag","data-status":s.status},n(rt(s.status)),9,ie)]),t("td",null,n(s.note||"-"),1),t("td",de,[t("div",ue,[t("button",{type:"button",class:"link-btn",onClick:J=>tt(s,"approve"),disabled:s.status!=="pending"},"通过",8,re),t("button",{type:"button",class:"link-btn",onClick:J=>tt(s,"reject"),disabled:s.status!=="pending"},"驳回",8,ce)])])]))),128))])):(i(),o("tbody",ve,[...e[34]||(e[34]=[t("tr",null,[t("td",{colspan:10,class:"placeholder"},"暂时没有提现申请。")],-1)])]))])]),t("footer",pe,[t("button",{type:"button",class:"btn btn--ghost",disabled:a.page<=1||b.value,onClick:e[8]||(e[8]=s=>Z(a.page-1))},"上一页",8,_e),t("span",null,"第 "+n(a.page)+" / "+n(A.value)+" 页",1),t("button",{type:"button",class:"btn btn--ghost",disabled:a.page>=A.value||b.value,onClick:e[9]||(e[9]=s=>Z(a.page+1))},"下一页",8,he),t("label",be,[e[35]||(e[35]=t("span",null,"每页",-1)),t("select",{class:"input",value:a.pageSize,onChange:e[10]||(e[10]=s=>pt(s))},[(i(),o(y,null,k(nt,s=>t("option",{key:s,value:s},n(s),9,me)),64))],40,fe)]),t("span",null,"共 "+n(D.value)+" 条",1)]),h.value?(i(),o("p",ge,n(h.value),1)):f.value?(i(),o("p",we,n(f.value),1)):S("",!0),P.value?(i(),o("div",{key:3,class:"modal",onClick:X(L,["self"])},[t("div",ye,[t("header",null,[t("h2",null,n(x.value==="approve"?"通过提现申请":"驳回提现申请"),1)]),t("section",ke,[r.value?(i(),o("p",Se,"提现号："+n(r.value.withdraw_id)+"，金额 "+n(E(r.value.amount)),1)):S("",!0),t("label",Ce,[e[36]||(e[36]=t("span",null,"备注（驳回需填写）",-1)),w(t("textarea",{class:"textarea","onUpdate:modelValue":e[11]||(e[11]=s=>g.value=s),rows:"4",placeholder:"请输入备注"},null,512),[[M,g.value,void 0,{trim:!0}]])])]),t("footer",xe,[t("button",{type:"button",class:"btn btn--ghost",onClick:L},"取消"),t("button",{type:"button",class:Ct(["btn",{"btn--danger":x.value==="reject"}]),disabled:U.value||x.value==="reject"&&g.value.length<2,onClick:mt}," 确认提交 ",10,Ie)])])])):S("",!0),B.value?(i(),o("div",{key:4,class:"modal",onClick:X(G,["self"])},[t("div",Me,[t("header",null,[t("h2",null,"批量通过 "+n(m.value.length)+" 条提现申请",1)]),t("section",ze,[e[38]||(e[38]=t("p",{class:"modal__hint"},"本次批量操作的提现号（最多展示三条）：",-1)),t("ul",We,[(i(!0),o(y,null,k(m.value.slice(0,3),s=>(i(),o("li",{key:s},n(s),1))),128)),m.value.length>3?(i(),o("li",je,"... 等 "+n(m.value.length)+" 条",1)):S("",!0)]),t("label",De,[e[37]||(e[37]=t("span",null,"备注（可选）",-1)),w(t("textarea",{class:"textarea","onUpdate:modelValue":e[12]||(e[12]=s=>I.value=s),rows:"4",placeholder:"输入备注"},null,512),[[M,I.value,void 0,{trim:!0}]])])]),t("footer",Ee,[t("button",{type:"button",class:"btn btn--ghost",onClick:G},"取消"),t("button",{type:"button",class:"btn",disabled:q.value,onClick:gt},"确认提交",8,Te)])])])):S("",!0)])}}}),$e=xt(Ve,[["__scopeId","data-v-4e2694d0"]]);export{$e as default};
