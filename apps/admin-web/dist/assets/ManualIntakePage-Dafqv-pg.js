import{d as Y,a as B,r as k,c as Z,b as r,e as a,f as h,A as ee,B as te,C as ae,i as c,s as f,v as I,t as m,j as U,F as g,h as C,y as ne,k as se,q as d,p as le,_ as oe}from"./index-DvtP9USg.js";import{v as S,a as P,c as O,b as T,U as re,m as de}from"./validators-CgxtYXVc.js";import{O as ie}from"./OrdersService-Bk90CBYk.js";import"./request-Bu45iIRO.js";const ue={class:"manual"},me={class:"manual__head"},pe={class:"manual__grid"},_e={class:"card manual__card"},ce={class:"form__grid"},be=["data-error"],fe=["disabled"],ve={key:0,class:"form__error"},he=["data-error"],ge=["disabled"],ye={key:0,class:"form__error"},ke=["data-error"],Ie={class:"form__combo"},xe=["disabled"],Ce=["value"],Ne=["disabled"],$e={key:0,class:"form__error"},Ue=["data-error"],we=["disabled"],Ae=["value"],Me={key:0,class:"form__error"},Ve=["data-error"],Be=["disabled"],Se=["value"],Pe={key:0,class:"form__error"},Oe=["data-error"],Te=["disabled"],je={key:0,class:"form__error"},Fe={class:"card manual__card"},Ee={class:"form__grid form__grid--single"},De={class:"form__field"},ze=["disabled"],Le=["value"],Re={class:"form__field"},Ge=["disabled"],Je={class:"form__field form__field--textarea"},qe=["disabled"],He={class:"attachments"},Ke=["data-disabled"],Qe=["disabled"],We={key:0,class:"attachments__list"},Xe=["data-status"],Ye={class:"attachments__name"},Ze={class:"attachments__size"},et={class:"attachments__status"},tt=["disabled","onClick"],at={class:"manual__confirm"},nt=["disabled"],st={class:"manual__actions"},lt=["disabled"],ot=["disabled"],rt={key:0,class:"feedback feedback--error"},dt={key:1,class:"feedback"},j=3,it=5*1024*1024,ut=Y({__name:"ManualIntakePage",setup(mt){const F=le(),n=B({phone:"",name:"",idType:"cn_id",idNumber:"",storeId:"",campaignId:"",amount:"",channel:"offline",promoterId:"",note:""}),l=B({phone:"",name:"",id_number:"",store_id:"",campaign_id:"",amount:""}),E=[{value:"cn_id",label:"大陆身份证"},{value:"passport",label:"护照"},{value:"hmt",label:"港澳台通行证"}],D=[{value:"S001",label:"天河路旗舰店"},{value:"S002",label:"海珠江畔店"},{value:"S003",label:"越秀公园店"}],z=[{value:"CAMP-01",label:"新客拉新 10 月"},{value:"CAMP-02",label:"会员返场节"},{value:"CAMP-03",label:"门店周年庆"}],L=[{value:"offline",label:"线下录单"},{value:"wechat",label:"微信"},{value:"h5",label:"H5 微站"},{value:"scan",label:"扫码"},{value:"api",label:"API 接口"}],N=k(!1),u=k(!1),x=k(""),_=k(""),b=k([]),$=k(!1),w=k(null),R=["image/png","image/jpeg","application/pdf"],M=Z(()=>b.value.length>=j||$.value);function A(s){var e;if(s&&typeof s=="object"){const o=s;if((e=o.body)!=null&&e.message)return o.body.message;if(o.message)return o.message}return"操作失败，请稍后再试"}function G(s){return s>=1024*1024?`${(s/1024/1024).toFixed(1)} MB`:s>=1024?`${(s/1024).toFixed(1)} KB`:`${s} B`}function V(){n.phone=n.phone.trim(),n.name=n.name.trim(),n.idNumber=n.idNumber.trim(),n.storeId=n.storeId.trim(),n.campaignId=n.campaignId.trim(),n.amount=n.amount.trim(),n.promoterId=n.promoterId.trim(),n.note=n.note.trim()}function y(s){switch(V(),s){case"phone":l.phone=T(n.phone)||"";break;case"name":l.name=O(n.name)||"";break;case"id_number":l.id_number=P(n.idNumber)||"";break;case"store_id":l.store_id=n.storeId?"":"请选择门店";break;case"campaign_id":l.campaign_id=n.campaignId?"":"请选择活动";break;case"amount":l.amount=S(n.amount)||"";break}}function J(){V();const s={phone:T(n.phone),name:O(n.name),id_number:P(n.idNumber),store_id:n.storeId?null:"请选择门店",campaign_id:n.campaignId?null:"请选择活动",amount:S(n.amount)},e=de(s);return Object.keys(l).forEach(o=>{o==="id_number"?l.id_number=e[o]||"":l[o]=e[o]||""}),Object.keys(e).length===0}function q(){n.phone="",n.name="",n.idType="cn_id",n.idNumber="",n.storeId="",n.campaignId="",n.amount="",n.channel="offline",n.promoterId="",n.note="",N.value=!1,Object.keys(l).forEach(s=>{l[s]=""}),x.value="",_.value=""}function H(){w.value&&(w.value.value="")}async function K(s){const e=s.target,o=e.files?Array.from(e.files):[];if(H(),!o.length)return;const t=j-b.value.length;if(t<=0)return;const i=[],v=[];o.slice(0,t).forEach(p=>{if(!R.includes(p.type)){v.push(`${p.name} 格式不支持`);return}if(p.size>it){v.push(`${p.name} 超过 5MB 限制`);return}i.push({id:`${Date.now()}-${Math.random().toString(16).slice(2)}`,name:p.name,size:p.size,status:"pending",file:p})}),v.length&&(_.value=v.join("；")),i.length&&(b.value=[...b.value,...i],await Q(i))}async function Q(s){$.value=!0;try{const o=(await re.createUploadPolicy({files:s.map(t=>{var i;return{filename:t.name,content_type:((i=t.file)==null?void 0:i.type)||"application/octet-stream",size:t.size}})})).uploads||[];for(let t=0;t<s.length;t+=1){const i=s[t],v=o[t];if(!v){i.status="error",i.error="缺少上传凭证";continue}i.status="uploading";try{const p=await fetch(v.upload_url,{method:"PUT",body:i.file,headers:v.headers||{}});if(!p.ok)throw new Error(`上传失败 (${p.status})`);i.status="done",i.remoteId=v.file_id,i.file=void 0}catch(p){i.status="error",i.error=A(p)}}}catch(e){const o=A(e);_.value=o,s.forEach(t=>{t.status="error",t.error=o})}finally{$.value=!1}}function W(s){b.value=b.value.filter(e=>e.id!==s)}async function X(){if(_.value="",x.value="",!J()){_.value="请完善必填项后再提交";return}if(!N.value){_.value="请勾选合规确认后再提交";return}if(n.note&&n.note.length>200){_.value="备注最多 200 字";return}if(b.value.some(s=>s.status==="uploading")){_.value="附件上传中，请稍后再试";return}u.value=!0;try{const s=b.value.filter(t=>t.remoteId).map(t=>t.remoteId)||[],e={phone:n.phone,name:n.name,id_type:n.idType,id_number:n.idNumber,store_id:n.storeId,campaign_id:n.campaignId,amount:n.amount,channel:n.channel};n.promoterId&&(e.promoter_id=n.promoterId),n.note&&(e.note=n.note),s.length&&(e.attachments=JSON.stringify(s));const o=await ie.submitOrder({fields:e,confirm_flag:!0});x.value="订单创建成功，正在跳转详情...",window.setTimeout(()=>{F.push(`/orders/${o.order_id}`)},600)}catch(s){_.value=A(s)}finally{u.value=!1}}return(s,e)=>{const o=ae("RouterLink");return d(),r("section",ue,[a("header",me,[e[19]||(e[19]=a("div",null,[a("h1",{class:"manual__title"},"手动录单"),a("p",{class:"manual__subtitle"},"在 AI 不可用或识别失败时，可通过标准化表单人工录入订单信息。")],-1)),ee(o,{class:"btn btn--ghost",to:"/intake/ai"},{default:te(()=>[...e[18]||(e[18]=[f("转 AI 录单",-1)])]),_:1})]),e[36]||(e[36]=a("article",{class:"manual__notice"},[a("strong",null,"录入提示："),a("span",null,"请确认已与客户取得授权，信息仅用于订单创建与风控校验。")],-1)),a("form",{class:"manual__form",onSubmit:se(X,["prevent"])},[a("div",pe,[a("fieldset",_e,[e[28]||(e[28]=a("legend",null,"基础信息",-1)),a("div",ce,[a("label",{class:"form__field","data-error":l.phone},[e[20]||(e[20]=a("span",null,[f("手机号"),a("em",null,"*")],-1)),c(a("input",{class:"input",type:"tel",placeholder:"请输入手机号","onUpdate:modelValue":e[0]||(e[0]=t=>n.phone=t),disabled:u.value,onBlur:e[1]||(e[1]=t=>y("phone"))},null,40,fe),[[I,n.phone]]),l.phone?(d(),r("span",ve,m(l.phone),1)):h("",!0)],8,be),a("label",{class:"form__field","data-error":l.name},[e[21]||(e[21]=a("span",null,[f("姓名"),a("em",null,"*")],-1)),c(a("input",{class:"input",type:"text",placeholder:"请输入姓名","onUpdate:modelValue":e[2]||(e[2]=t=>n.name=t),disabled:u.value,onBlur:e[3]||(e[3]=t=>y("name"))},null,40,ge),[[I,n.name]]),l.name?(d(),r("span",ye,m(l.name),1)):h("",!0)],8,he),a("label",{class:"form__field form__field--combo","data-error":l.id_number},[e[22]||(e[22]=a("span",null,[f("证件号"),a("em",null,"*")],-1)),a("div",Ie,[c(a("select",{class:"input","onUpdate:modelValue":e[4]||(e[4]=t=>n.idType=t),disabled:u.value,onChange:e[5]||(e[5]=t=>y("id_number"))},[(d(),r(g,null,C(E,t=>a("option",{key:t.value,value:t.value},m(t.label),9,Ce)),64))],40,xe),[[U,n.idType]]),c(a("input",{class:"input",type:"text",placeholder:"请输入证件号码","onUpdate:modelValue":e[6]||(e[6]=t=>n.idNumber=t),disabled:u.value,onBlur:e[7]||(e[7]=t=>y("id_number"))},null,40,Ne),[[I,n.idNumber]])]),l.id_number?(d(),r("span",$e,m(l.id_number),1)):h("",!0)],8,ke),a("label",{class:"form__field","data-error":l.store_id},[e[24]||(e[24]=a("span",null,[f("门店"),a("em",null,"*")],-1)),c(a("select",{class:"input","onUpdate:modelValue":e[8]||(e[8]=t=>n.storeId=t),disabled:u.value,onChange:e[9]||(e[9]=t=>y("store_id"))},[e[23]||(e[23]=a("option",{value:""},"请选择门店",-1)),(d(),r(g,null,C(D,t=>a("option",{key:t.value,value:t.value},m(t.label),9,Ae)),64))],40,we),[[U,n.storeId]]),l.store_id?(d(),r("span",Me,m(l.store_id),1)):h("",!0)],8,Ue),a("label",{class:"form__field","data-error":l.campaign_id},[e[26]||(e[26]=a("span",null,[f("活动"),a("em",null,"*")],-1)),c(a("select",{class:"input","onUpdate:modelValue":e[10]||(e[10]=t=>n.campaignId=t),disabled:u.value,onChange:e[11]||(e[11]=t=>y("campaign_id"))},[e[25]||(e[25]=a("option",{value:""},"请选择活动",-1)),(d(),r(g,null,C(z,t=>a("option",{key:t.value,value:t.value},m(t.label),9,Se)),64))],40,Be),[[U,n.campaignId]]),l.campaign_id?(d(),r("span",Pe,m(l.campaign_id),1)):h("",!0)],8,Ve),a("label",{class:"form__field","data-error":l.amount},[e[27]||(e[27]=a("span",null,[f("金额 (¥)"),a("em",null,"*")],-1)),c(a("input",{class:"input",type:"number",step:"0.01",placeholder:"请输入金额","onUpdate:modelValue":e[12]||(e[12]=t=>n.amount=t),disabled:u.value,onBlur:e[13]||(e[13]=t=>y("amount"))},null,40,Te),[[I,n.amount]]),l.amount?(d(),r("span",je,m(l.amount),1)):h("",!0)],8,Oe)])]),a("section",Fe,[e[34]||(e[34]=a("h2",null,"附加信息",-1)),a("div",Ee,[a("label",De,[e[29]||(e[29]=a("span",null,"渠道",-1)),c(a("select",{class:"input","onUpdate:modelValue":e[14]||(e[14]=t=>n.channel=t),disabled:u.value},[(d(),r(g,null,C(L,t=>a("option",{key:t.value,value:t.value},m(t.label),9,Le)),64))],8,ze),[[U,n.channel]])]),a("label",Re,[e[30]||(e[30]=a("span",null,"推广人",-1)),c(a("input",{class:"input",type:"text",placeholder:"可选填推广人 ID","onUpdate:modelValue":e[15]||(e[15]=t=>n.promoterId=t),disabled:u.value},null,8,Ge),[[I,n.promoterId]])]),a("label",Je,[e[31]||(e[31]=a("span",null,"备注",-1)),c(a("textarea",{class:"textarea",rows:"4",placeholder:"记录补充说明，不超过 200 字","onUpdate:modelValue":e[16]||(e[16]=t=>n.note=t),disabled:u.value},null,8,qe),[[I,n.note]])])]),a("div",He,[e[33]||(e[33]=a("header",null,[a("h3",null,"补充材料"),a("p",null,"支持 JPG/PNG/PDF，单个 ≤ 5MB，最多 3 个。")],-1)),a("div",{class:"attachments__uploader","data-disabled":M.value},[a("input",{ref_key:"attachmentsInput",ref:w,type:"file",class:"attachments__input",accept:".jpg,.jpeg,.png,.pdf",multiple:"",disabled:M.value,onChange:K},null,40,Qe),e[32]||(e[32]=a("span",null,"拖拽或点击上传补充材料",-1))],8,Ke),b.value.length?(d(),r("ul",We,[(d(!0),r(g,null,C(b.value,t=>(d(),r("li",{key:t.id,class:"attachments__item","data-status":t.status},[a("span",Ye,m(t.name),1),a("span",Ze,m(G(t.size)),1),a("span",et,[t.status==="done"?(d(),r(g,{key:0},[f("已上传")],64)):t.status==="uploading"?(d(),r(g,{key:1},[f("上传中...")],64)):t.status==="error"?(d(),r(g,{key:2},[f(m(t.error||"失败"),1)],64)):h("",!0)]),a("button",{type:"button",class:"link-btn",disabled:t.status==="uploading"&&$.value,onClick:i=>W(t.id)}," 删除 ",8,tt)],8,Xe))),128))])):h("",!0)])])]),a("label",at,[c(a("input",{type:"checkbox","onUpdate:modelValue":e[17]||(e[17]=t=>N.value=t),disabled:u.value},null,8,nt),[[ne,N.value]]),e[35]||(e[35]=a("span",null,"我已阅读并遵守数据合规提示，确保信息来源合法真实。",-1))]),a("footer",st,[a("button",{type:"button",class:"btn btn--ghost",disabled:u.value,onClick:q},"重置",8,lt),a("button",{type:"submit",class:"btn",disabled:u.value},m(u.value?"提交中...":"提交订单"),9,ot)])],32),_.value?(d(),r("p",rt,m(_.value),1)):x.value?(d(),r("p",dt,m(x.value),1)):h("",!0)])}}}),ft=oe(ut,[["__scopeId","data-v-94f5ba84"]]);export{ft as default};
