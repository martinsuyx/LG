import{O as L,d as ke,r as p,c as x,a as N,z as be,b as n,e as r,f as g,A as me,B as ge,C as we,s as M,F as T,h as G,t as _,m as J,k as Ie,i as K,D as Se,n as xe,y as Ae,q as o,p as je,_ as Fe}from"./index-DvtP9USg.js";import{v as H,a as Q,b as W,c as X,U as Ce,m as Pe}from"./validators-CgxtYXVc.js";import{r as Y}from"./request-Bu45iIRO.js";import{O as Ee}from"./OrdersService-Bk90CBYk.js";class Z{static startAiIntake(A){return Y(L,{method:"POST",url:"/api/v1/orders/ai-intake",body:A,mediaType:"application/json",errors:{400:"Invalid payload or unsupported images."}})}static getAiIntakeStatus(A){return Y(L,{method:"GET",url:"/api/v1/orders/ai-intake/{job_id}",path:{job_id:A},errors:{404:"Job not found."}})}}const Me={class:"intake"},Ue={class:"intake__head"},$e={class:"intake__grid"},Be={class:"card intake__card"},qe=["data-disabled"],De=["disabled"],Oe={key:0,class:"uploader__list"},Re=["data-status"],Ve={class:"uploader__preview"},ze=["src","alt"],Le={key:1,class:"uploader__placeholder"},Ne={class:"uploader__meta"},Te={key:0,class:"progress"},Ge={key:1,class:"progress progress--error"},Je=["disabled","onClick"],Ke=["data-status"],He={class:"progress"},Qe={class:"parse-status__text"},We=["disabled"],Xe={class:"card intake__card"},Ye={class:"form__grid"},Ze=["data-error"],ea={class:"form__label"},aa={key:0},ta=["data-low"],sa=["type","placeholder","onUpdate:modelValue","disabled","onBlur"],ra={key:0,class:"form__error"},la={class:"form__confirm"},na=["disabled"],oa={class:"form__actions"},ua=["disabled"],ia={key:0,class:"feedback feedback--error"},da={key:1,class:"feedback"},ee=5,ca=5*1024*1024,pa=1500,va=ke({__name:"AiIntakePage",setup(ae){const A=je(),te=["image/png","image/jpeg"],v=p([]),k=p(!1),U=p(null),i=p("idle"),f=p(""),se=x(()=>{switch(i.value){case"starting":return 15;case"parsing":return 65;case"parsed":return 100;case"failed":return 100;default:return 0}}),F=p(null),w=p(""),C=p([]),b=[{key:"name",label:"客户姓名",placeholder:"请输入姓名",required:!0,type:"text"},{key:"phone",label:"手机号",placeholder:"请输入手机号",required:!0,type:"tel"},{key:"id_number",label:"证件号",placeholder:"请输入证件号",required:!0,type:"text"},{key:"store_id",label:"门店编码",placeholder:"请输入门店编码",required:!0,type:"text"},{key:"campaign_id",label:"活动 ID",placeholder:"请输入活动 ID",required:!0,type:"text"},{key:"amount",label:"订单金额 (¥)",placeholder:"请输入金额",required:!0,type:"number"}],d=N(b.reduce((e,a)=>(e[a.key]="",e),{})),I=N(b.reduce((e,a)=>(e[a.key]="",e),{})),P=p(!1),S=p(!1),y=p(""),u=p(""),B=x(()=>v.value.filter(e=>e.remoteId&&e.status==="done").map(e=>e.remoteId)),E=x(()=>B.value.length>0),$=x(()=>C.value.reduce((e,a)=>(e[a.key]=a,e),{})),re=x(()=>i.value==="parsed"&&P.value&&!S.value),q=x(()=>k.value||v.value.length>=ee);function le(e){return e>=1024*1024?`${(e/1024/1024).toFixed(1)} MB`:e>=1024?`${(e/1024).toFixed(1)} KB`:`${e} B`}function ne(e){return`${Math.round(e*100)}%`}function D(e){const a=$.value[e];return a?a.confidence<.9:!1}function j(e){var a;if(e&&typeof e=="object"){const s=e;if((a=s.body)!=null&&a.message)return s.body.message;if(s.message)return s.message}return"操作失败，请稍后再试"}function oe(){U.value&&(U.value.value="")}function O(e){e.preview&&URL.revokeObjectURL(e.preview)}function m(){F.value!==null&&(window.clearInterval(F.value),F.value=null)}function ue(){m(),i.value="idle",f.value="",w.value="",C.value=[],y.value=""}function R(){b.forEach(e=>{d[e.key]=d[e.key].trim()})}function ie(e){R();const a=d[e];let s=null;switch(e){case"name":s=X(a);break;case"phone":s=W(a);break;case"id_number":s=Q(a);break;case"store_id":s=a?null:"请输入门店编码";break;case"campaign_id":s=a?null:"请输入活动 ID";break;case"amount":s=H(a);break;default:s=null}I[e]=s||""}function de(){R();const e={name:X(d.name),phone:W(d.phone),id_number:Q(d.id_number),store_id:d.store_id?null:"请输入门店编码",campaign_id:d.campaign_id?null:"请输入活动 ID",amount:H(d.amount)},a=Pe(e);return b.forEach(s=>{I[s.key]=a[s.key]||""}),Object.keys(a).length===0}async function ce(e){const a=e.target,s=a.files?Array.from(a.files):[];if(oe(),!s.length)return;u.value="",y.value="";const t=ee-v.value.length;if(t<=0)return;const l=[],h=[];s.slice(0,t).forEach(c=>{if(!te.includes(c.type)){h.push(`${c.name} 格式不支持`);return}if(c.size>ca){h.push(`${c.name} 超过 5MB 限制`);return}const ye=`${Date.now()}-${Math.random().toString(16).slice(2)}`;l.push({id:ye,name:c.name,size:c.size,preview:URL.createObjectURL(c),status:"pending",progress:0,file:c})}),h.length&&(u.value=h.join("；")),l.length&&(v.value=[...v.value,...l],await pe(l))}async function pe(e){k.value=!0;try{const s=(await Ce.createUploadPolicy({files:e.map(t=>{var l;return{filename:t.name,content_type:((l=t.file)==null?void 0:l.type)||"application/octet-stream",size:t.size}})})).uploads||[];for(let t=0;t<e.length;t+=1){const l=e[t],h=s[t];if(!h){l.status="error",l.error="缺少上传凭证";continue}l.status="uploading",l.progress=20;try{const c=await fetch(h.upload_url,{method:"PUT",body:l.file,headers:h.headers||{}});if(!c.ok)throw new Error(`上传失败 (${c.status})`);l.progress=100,l.status="done",l.remoteId=h.file_id,l.file=void 0}catch(c){l.status="error",l.error=j(c)}}}catch(a){const s=j(a);u.value=s,e.forEach(t=>{t.status="error",t.error=s})}finally{k.value=!1}E.value&&await V()}async function V(){if(E.value){i.value="starting",f.value="正在提交解析任务...",y.value="",u.value="",m();try{const e=await Z.startAiIntake({images:B.value});w.value=e.job_id,i.value="parsing",f.value="AI 正在解析字段...",await z(),F.value=window.setInterval(z,pa)}catch(e){i.value="failed",f.value="解析任务提交失败，请重试",u.value=j(e)}}}async function z(){if(w.value)try{const e=await Z.getAiIntakeStatus(w.value);ve(e)}catch(e){m(),i.value="failed",f.value="解析状态获取失败，请重试",u.value=j(e)}}function ve(e){var a;switch(e.status){case"uploaded":case"parsing":i.value="parsing",f.value="AI 正在解析字段...";break;case"parsed":i.value="parsed",f.value="解析完成，请核对结果",y.value="解析完成，表单已自动填充关键字段。",C.value=e.fields||[],C.value.forEach(s=>{s.key in d&&(d[s.key]=s.value??"")}),b.forEach(s=>{I[s.key]=""}),m();break;case"failed":i.value="failed",f.value="解析失败，可重试或转人工录单",u.value=((a=e.errors)==null?void 0:a.join("；"))||"AI 解析失败，请检查资料质量",m();break;default:i.value="failed",f.value="解析状态异常，请重试",u.value="未知解析状态",m()}}function _e(){k.value||V()}function fe(e){const a=v.value.find(s=>s.id===e);a&&(k.value&&a.status==="uploading"||(O(a),v.value=v.value.filter(s=>s.id!==e),E.value||ue()))}async function he(){if(u.value="",y.value="",!de()){u.value="请检查必填字段后再提交";return}if(!P.value){u.value="请勾选确认已核对信息";return}if(!w.value){u.value="解析任务尚未完成，请稍后重试";return}S.value=!0;try{const e=b.reduce((s,t)=>(s[t.key]=d[t.key],s),{}),a=await Ee.submitOrder({job_id:w.value,fields:e,confirm_flag:!0});y.value="提交成功，正在跳转订单详情...",window.setTimeout(()=>{A.push(`/orders/${a.order_id}`)},600)}catch(e){u.value=j(e)}finally{S.value=!1}}return be(()=>{m(),v.value.forEach(O)}),(e,a)=>{const s=we("RouterLink");return o(),n("section",Me,[r("header",Ue,[a[2]||(a[2]=r("div",null,[r("h1",{class:"intake__title"},"AI 录单"),r("p",{class:"intake__subtitle"},"上传证件或资料照片，AI 将自动解析并预填关键字段，请核对后提交。")],-1)),me(s,{class:"btn btn--ghost",to:"/intake/manual"},{default:ge(()=>[...a[1]||(a[1]=[M("转人工录单",-1)])]),_:1})]),r("div",$e,[r("section",Be,[a[5]||(a[5]=r("header",{class:"card__head"},[r("h2",null,"上传材料"),r("p",null,"支持 JPG/PNG，单张 ≤ 5MB，最多 5 张。")],-1)),r("div",{class:"uploader","data-disabled":q.value},[r("input",{ref_key:"fileInput",ref:U,class:"uploader__input",type:"file",accept:".jpg,.jpeg,.png",multiple:"",disabled:q.value,onChange:ce},null,40,De),a[3]||(a[3]=r("p",{class:"uploader__hint"},[r("strong",null,"拖拽"),M("或"),r("strong",null,"点击"),M("上传身份证、合同等图片 ")],-1)),a[4]||(a[4]=r("p",{class:"uploader__sub"},"上传完成后将自动触发 AI 解析",-1))],8,qe),v.value.length?(o(),n("ul",Oe,[(o(!0),n(T,null,G(v.value,t=>(o(),n("li",{key:t.id,class:"uploader__item","data-status":t.status},[r("figure",Ve,[t.preview?(o(),n("img",{key:0,src:t.preview,alt:t.name},null,8,ze)):(o(),n("div",Le,_(t.name.slice(0,1).toUpperCase()),1))]),r("div",Ne,[r("strong",null,_(t.name),1),r("span",null,_(le(t.size)),1),t.status!=="error"?(o(),n("div",Te,[r("div",{class:"progress__bar",style:J({width:`${t.progress}%`})},null,4)])):(o(),n("p",Ge,_(t.error||"上传失败"),1))]),r("button",{type:"button",class:"link-btn uploader__remove",disabled:k.value&&t.status==="uploading",onClick:l=>fe(t.id)}," 删除 ",8,Je)],8,Re))),128))])):g("",!0),i.value!=="idle"?(o(),n("div",{key:1,class:"parse-status","data-status":i.value},[r("div",He,[r("div",{class:"progress__bar",style:J({width:`${se.value}%`})},null,4)]),r("div",Qe,[r("span",null,_(f.value),1),i.value==="failed"?(o(),n("button",{key:0,type:"button",class:"btn btn--ghost",disabled:k.value||!E.value,onClick:_e}," 重新解析 ",8,We)):g("",!0)])],8,Ke)):g("",!0)]),r("section",Xe,[a[7]||(a[7]=r("header",{class:"card__head"},[r("h2",null,"解析结果"),r("p",null,"低置信度字段将标记为黄色，请完善后提交。")],-1)),r("form",{class:"form",onSubmit:Ie(he,["prevent"])},[r("div",Ye,[(o(),n(T,null,G(b,t=>r("label",{key:t.key,class:"form__field","data-error":I[t.key]},[r("span",ea,[M(_(t.label)+" ",1),t.required?(o(),n("em",aa,"*")):g("",!0),$.value[t.key]?(o(),n("small",{key:1,"data-low":D(t.key)}," AI 置信度："+_(ne($.value[t.key].confidence)),9,ta)):g("",!0)]),K(r("input",{class:xe(["input",{"is-low":D(t.key)}]),type:t.type,placeholder:t.placeholder,"onUpdate:modelValue":l=>d[t.key]=l,disabled:S.value,onBlur:l=>ie(t.key)},null,42,sa),[[Se,d[t.key]]]),I[t.key]?(o(),n("span",ra,_(I[t.key]),1)):g("",!0)],8,Ze)),64))]),r("label",la,[K(r("input",{type:"checkbox","onUpdate:modelValue":a[0]||(a[0]=t=>P.value=t),disabled:S.value},null,8,na),[[Ae,P.value]]),a[6]||(a[6]=r("span",null,"我已核对信息并确认无误",-1))]),r("div",oa,[r("button",{type:"submit",class:"btn",disabled:!re.value},_(S.value?"提交中...":"提交订单"),9,ua)])],32)])]),u.value?(o(),n("p",ia,_(u.value),1)):y.value?(o(),n("p",da,_(y.value),1)):g("",!0)])}}}),ka=Fe(va,[["__scopeId","data-v-bf51e794"]]);export{ka as default};
