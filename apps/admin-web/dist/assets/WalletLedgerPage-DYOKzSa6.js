import{d as dt,a as ut,r,c as R,o as rt,x as vt,b as o,e as t,f as j,i as b,v as F,j as V,F as y,h as k,t as a,k as q,s as A,n as pt,p as ct,q as i,_ as ft}from"./index-DvtP9USg.js";import{E as _t}from"./ExportsService-BVSn6J7L.js";import{W as K}from"./WalletService-Clh4FYxu.js";import"./request-Bu45iIRO.js";const mt={class:"ledger"},gt={class:"ledger__head"},bt={class:"ledger__actions"},yt=["disabled"],kt={class:"filters__group"},xt={class:"filters__row"},St={class:"filters__field"},Ct={class:"filters__field"},Dt={class:"filters__field"},zt=["value"],Tt={class:"filters__field"},It={class:"filters__field"},Mt=["value"],ht={class:"filters__field"},Ft=["value"],Vt={class:"filters__actions"},Nt=["disabled"],$t=["disabled"],wt={class:"stats"},Lt={class:"stat-card"},Ot={class:"stat-card__value"},Wt={class:"stat-card"},Et={class:"stat-card__value"},Ut={class:"stat-card"},Pt=["data-positive"],Bt={class:"table-card"},Rt=["data-active"],jt=["data-active"],qt={key:0},At={key:1},Kt=["onClick"],Yt=["onClick"],Gt={key:1},Ht={key:2},Jt={class:"pager"},Qt=["disabled"],Xt=["disabled"],Zt={class:"pager__size"},te=["value"],ee=["value"],le={key:0,class:"feedback feedback--error"},se={key:1,class:"feedback"},ne={class:"modal__body"},ae={class:"modal__content"},oe=dt({__name:"WalletLedgerPage",setup(ie){const Y=vt(),G=ct(),N=new Date,$=N.toISOString().slice(0,10),z=new Date(N);z.setDate(z.getDate()-6);const w=z.toISOString().slice(0,10),l=ut({start:w,end:$,dimension:"platform",entityId:"",txType:[],txStatus:[],page:1,pageSize:20}),L=[{value:"platform",label:"平台"},{value:"company",label:"公司"},{value:"team",label:"团队"},{value:"store",label:"门店"},{value:"promoter",label:"推广人"},{value:"individual",label:"个人"}],H=["order_settlement","freeze","unfreeze","withdraw","adjustment"],J=["success","pending","failed"],Q=[20,50,100,200],x=r(null),T=r([]),D=r(0),v=r(!1),m=r(""),S=r(""),f=r("created_at"),g=r("desc"),d=r(null),X=new Intl.NumberFormat("zh-CN",{style:"currency",currency:"CNY",minimumFractionDigits:2}),Z=new Intl.DateTimeFormat("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),O=R(()=>[...T.value].sort((e,p)=>{let u=0,c=0;f.value==="amount"?(u=e.amount??0,c=p.amount??0):(u=new Date(e.created_at??"").getTime(),c=new Date(p.created_at??"").getTime());const C=u-c;return g.value==="asc"?C:-C})),I=R(()=>Math.max(1,Math.ceil(D.value/l.pageSize)));function _(n){return n==null?"-":X.format(n)}function W(n){if(!n)return"-";try{return Z.format(new Date(n))}catch{return n}}function E(n,e="加载钱包流水失败，请稍后再试。"){return n?n.includes("Failed to fetch")||n.includes("NetworkError")?"无法连接到钱包流水接口，请确认 Mock 服务已启动或网络可用。":n:e}function tt(){l.start=w,l.end=$,l.dimension="platform",l.entityId="",l.txType=[],l.txStatus=[],l.page=1,l.pageSize=20,h()}function et(){l.page=1,h()}function U(n){const e=Math.min(Math.max(n,1),I.value);e!==l.page&&(l.page=e,M())}function lt(n){const e=Number(n.target.value);l.pageSize!==e&&(l.pageSize=e,l.page=1,M())}function P(n){f.value===n?g.value=g.value==="asc"?"desc":"asc":(f.value=n,g.value=n==="created_at"?"desc":"asc")}function st(n){d.value=n}function B(){d.value=null}function nt(n){n&&G.push(`/orders/${n}`)}async function at(){S.value="",m.value="";try{await _t.exportWalletLedger(),S.value="已创建导出任务，请前往导出中心查看。"}catch(n){m.value=E(n==null?void 0:n.message,"导出失败，请稍后再试。")}}async function ot(){x.value=await K.getWalletLedgerStats(l.start||void 0,l.end||void 0,l.dimension,l.entityId||void 0)}async function M(){const n=await K.listWalletLedger(l.start||void 0,l.end||void 0,l.dimension,l.entityId||void 0,l.txType.length?l.txType:void 0,l.txStatus.length?l.txStatus:void 0,l.page,l.pageSize);T.value=n.items??[],D.value=n.total??0}async function h(){v.value=!0,m.value="",S.value="";try{await Promise.all([ot(),M()])}catch(n){m.value=E(n==null?void 0:n.message),T.value=[],D.value=0}finally{v.value=!1}}return rt(()=>{const{dimension:n,entity_id:e,start:p,end:u}=Y.query;typeof n=="string"&&L.some(c=>c.value===n)&&(l.dimension=n),typeof e=="string"&&(l.entityId=e),typeof p=="string"&&(l.start=p),typeof u=="string"&&(l.end=u),h()}),(n,e)=>{var p,u,c,C;return i(),o("section",mt,[t("header",gt,[e[11]||(e[11]=t("div",null,[t("h1",{class:"ledger__title"},"钱包流水"),t("p",{class:"ledger__subtitle"},"按维度查看资金流动，支持筛选、导出和详情查看。")],-1)),t("div",bt,[t("button",{type:"button",class:"btn",onClick:at,disabled:v.value},"导出当前筛选",8,yt)])]),t("form",{class:"filters",onSubmit:q(et,["prevent"])},[t("fieldset",kt,[e[18]||(e[18]=t("legend",null,"筛选条件",-1)),t("div",xt,[t("label",St,[e[12]||(e[12]=t("span",null,"开始日期",-1)),b(t("input",{class:"input",type:"date","onUpdate:modelValue":e[0]||(e[0]=s=>l.start=s)},null,512),[[F,l.start]])]),t("label",Ct,[e[13]||(e[13]=t("span",null,"结束日期",-1)),b(t("input",{class:"input",type:"date","onUpdate:modelValue":e[1]||(e[1]=s=>l.end=s)},null,512),[[F,l.end]])]),t("label",Dt,[e[14]||(e[14]=t("span",null,"维度",-1)),b(t("select",{class:"input","onUpdate:modelValue":e[2]||(e[2]=s=>l.dimension=s)},[(i(),o(y,null,k(L,s=>t("option",{key:s.value,value:s.value},a(s.label),9,zt)),64))],512),[[V,l.dimension]])]),t("label",Tt,[e[15]||(e[15]=t("span",null,"主体 ID",-1)),b(t("input",{class:"input",type:"text","onUpdate:modelValue":e[3]||(e[3]=s=>l.entityId=s),placeholder:"如 S001"},null,512),[[F,l.entityId,void 0,{trim:!0}]])]),t("label",It,[e[16]||(e[16]=t("span",null,"交易类型",-1)),b(t("select",{class:"input",multiple:"","onUpdate:modelValue":e[4]||(e[4]=s=>l.txType=s)},[(i(),o(y,null,k(H,s=>t("option",{key:s,value:s},a(s),9,Mt)),64))],512),[[V,l.txType]])]),t("label",ht,[e[17]||(e[17]=t("span",null,"状态",-1)),b(t("select",{class:"input",multiple:"","onUpdate:modelValue":e[5]||(e[5]=s=>l.txStatus=s)},[(i(),o(y,null,k(J,s=>t("option",{key:s,value:s},a(s),9,Ft)),64))],512),[[V,l.txStatus]])])]),t("div",Vt,[t("button",{type:"submit",class:"btn",disabled:v.value},"应用筛选",8,Nt),t("button",{type:"button",class:"btn btn--ghost",onClick:tt,disabled:v.value},"重置",8,$t)])])],32),t("section",wt,[t("article",Lt,[e[19]||(e[19]=t("span",{class:"stat-card__label"},"入账总额",-1)),t("strong",Ot,a(_((p=x.value)==null?void 0:p.in_total)),1)]),t("article",Wt,[e[20]||(e[20]=t("span",{class:"stat-card__label"},"出账总额",-1)),t("strong",Et,a(_((u=x.value)==null?void 0:u.out_total)),1)]),t("article",Ut,[e[21]||(e[21]=t("span",{class:"stat-card__label"},"净额",-1)),t("strong",{class:"stat-card__value","data-positive":(((c=x.value)==null?void 0:c.net)??0)>=0},a(_((C=x.value)==null?void 0:C.net)),9,Pt)])]),t("div",Bt,[t("table",null,[t("thead",null,[t("tr",null,[e[24]||(e[24]=t("th",null,"流水号",-1)),t("th",{class:"sortable",onClick:e[6]||(e[6]=s=>P("created_at"))},[e[22]||(e[22]=A(" 时间 ",-1)),t("span",{class:"sort-ind","data-active":f.value==="created_at"},a(f.value==="created_at"?g.value==="asc"?"↑":"↓":""),9,Rt)]),e[25]||(e[25]=t("th",null,"主体",-1)),e[26]||(e[26]=t("th",null,"类型",-1)),e[27]||(e[27]=t("th",null,"关联订单",-1)),t("th",{class:"sortable",onClick:e[7]||(e[7]=s=>P("amount"))},[e[23]||(e[23]=A(" 金额 ",-1)),t("span",{class:"sort-ind","data-active":f.value==="amount"},a(f.value==="amount"?g.value==="asc"?"↑":"↓":""),9,jt)]),e[28]||(e[28]=t("th",null,"交易后余额",-1)),e[29]||(e[29]=t("th",null,"状态",-1)),e[30]||(e[30]=t("th",null,"备注",-1))])]),v.value?(i(),o("tbody",qt,[(i(),o(y,null,k(5,s=>t("tr",{key:`loading-${s}`},[...e[31]||(e[31]=[t("td",{colspan:9},[t("div",{class:"skeleton"})],-1)])])),64))])):O.value.length?(i(),o("tbody",At,[(i(!0),o(y,null,k(O.value,s=>(i(),o("tr",{key:s.tx_id},[t("td",null,[t("button",{type:"button",class:"link-btn",onClick:it=>st(s)},a(s.tx_id),9,Kt)]),t("td",null,a(W(s.created_at)),1),t("td",null,a(s.entity_name),1),t("td",null,a(s.tx_type),1),t("td",null,[s.order_id?(i(),o("button",{key:0,type:"button",class:"link-btn",onClick:it=>nt(s.order_id)},a(s.order_id),9,Yt)):(i(),o("span",Gt,"-"))]),t("td",{class:pt({"is-negative":s.amount<0})},a(_(s.amount)),3),t("td",null,a(_(s.balance_after)),1),t("td",null,a(s.status),1),t("td",null,a(s.note||"-"),1)]))),128))])):(i(),o("tbody",Ht,[...e[32]||(e[32]=[t("tr",null,[t("td",{colspan:9,class:"placeholder"},"暂无流水记录。")],-1)])]))])]),t("footer",Jt,[t("button",{type:"button",class:"btn btn--ghost",disabled:l.page<=1||v.value,onClick:e[8]||(e[8]=s=>U(l.page-1))},"上一页",8,Qt),t("span",null,"第 "+a(l.page)+" / "+a(I.value)+" 页",1),t("button",{type:"button",class:"btn btn--ghost",disabled:l.page>=I.value||v.value,onClick:e[9]||(e[9]=s=>U(l.page+1))},"下一页",8,Xt),t("label",Zt,[e[33]||(e[33]=t("span",null,"每页",-1)),t("select",{class:"input",value:l.pageSize,onChange:e[10]||(e[10]=s=>lt(s))},[(i(),o(y,null,k(Q,s=>t("option",{key:s,value:s},a(s),9,ee)),64))],40,te)]),t("span",null,"共 "+a(D.value)+" 条",1)]),m.value?(i(),o("p",le,a(m.value),1)):S.value?(i(),o("p",se,a(S.value),1)):j("",!0),d.value?(i(),o("div",{key:2,class:"modal",onClick:q(B,["self"])},[t("div",ne,[t("header",null,[t("h2",null,"流水详情 "+a(d.value.tx_id),1)]),t("section",ae,[t("dl",null,[t("div",null,[e[34]||(e[34]=t("dt",null,"时间",-1)),t("dd",null,a(W(d.value.created_at)),1)]),t("div",null,[e[35]||(e[35]=t("dt",null,"主体",-1)),t("dd",null,a(d.value.entity_name),1)]),t("div",null,[e[36]||(e[36]=t("dt",null,"类型",-1)),t("dd",null,a(d.value.tx_type),1)]),t("div",null,[e[37]||(e[37]=t("dt",null,"金额",-1)),t("dd",null,a(_(d.value.amount)),1)]),t("div",null,[e[38]||(e[38]=t("dt",null,"交易后余额",-1)),t("dd",null,a(_(d.value.balance_after)),1)]),t("div",null,[e[39]||(e[39]=t("dt",null,"状态",-1)),t("dd",null,a(d.value.status),1)]),t("div",null,[e[40]||(e[40]=t("dt",null,"备注",-1)),t("dd",null,a(d.value.note||"-"),1)])])]),t("footer",{class:"modal__footer"},[t("button",{type:"button",class:"btn",onClick:B},"关闭")])])])):j("",!0)])}}}),pe=ft(oe,[["__scopeId","data-v-cd42ceff"]]);export{pe as default};
