import{O as ie,d as Re,a as ue,r as d,c as A,o as $e,b as o,e,f as I,t as n,i as f,v as O,j as J,F as C,h as S,k as De,n as K,p as Te,q as i,_ as Ee}from"./index-DvtP9USg.js";import{r as de}from"./request-Bu45iIRO.js";import{O as W}from"./OrdersService-Bk90CBYk.js";class re{static listReviewOrders(z,M,P,R,V,a,q,B=1,L=20){return de(ie,{method:"GET",url:"/api/v1/review/orders",query:{start:z,end:M,status:P,channel:R,store_code:V,campaign_id:a,risk_tag:q,page:B,page_size:L},errors:{400:"Invalid filters supplied."}})}static getReviewStats(z,M){return de(ie,{method:"GET",url:"/api/v1/review/stats",query:{start:z,end:M},errors:{400:"Invalid date range supplied."}})}}const Pe={class:"review"},Ve={class:"review__head"},Fe={key:0,class:"review__stats"},Ne={class:"stat-card"},Ue={class:"stat-card__value"},je={class:"stat-card"},Ae={class:"stat-card__value"},qe={class:"stat-card"},Be={class:"stat-card__value"},Le={class:"filters__group"},Ge={class:"filters__row"},Qe={class:"filters__field"},Ye={class:"filters__field"},He={class:"filters__field"},Je=["value"],Ke={class:"filters__field"},We=["value"],Xe={class:"filters__field"},Ze={class:"filters__field"},et={class:"filters__field"},tt={class:"filters__actions"},lt=["disabled"],st=["disabled"],at={class:"review__layout"},nt={class:"queue"},ot={key:0,class:"queue__batch-bar"},it={class:"queue__batch-actions"},ut={class:"table-card"},dt={class:"col-checkbox"},rt=["checked"],vt={key:0},ct={key:1},pt={class:"col-checkbox"},_t=["checked","onChange"],gt=["onClick"],ft={key:0,class:"risk-flag"},bt={key:1},ht={class:"actions-col"},yt={class:"row-actions"},mt=["onClick"],kt=["onClick"],wt={key:2},Ct={class:"pager"},St=["disabled"],Mt=["disabled"],xt={class:"pager__size"},It=["value"],Ot=["value"],zt={class:"preview"},Rt={key:0,class:"placeholder"},$t={key:1,class:"feedback feedback--error"},Dt={key:2,class:"preview__card"},Tt={class:"preview__head"},Et=["data-status"],Pt={class:"preview__audits"},Vt={key:3,class:"placeholder"},Ft={key:0,class:"feedback feedback--error"},Nt={key:1,class:"feedback"},Ut={key:2,class:"modal"},jt={class:"modal__body"},At={class:"modal__content"},qt={class:"modal__field"},Bt={class:"modal__footer"},Lt=["disabled"],Gt={key:3,class:"modal"},Qt={class:"modal__body"},Yt={class:"modal__content"},Ht={class:"modal__list"},Jt={key:0},Kt={class:"modal__field"},Wt={class:"modal__footer"},Xt=["disabled"],Zt=Re({__name:"ReviewPage",setup(ve){const z=Te(),M=new Date,P=M.toISOString().slice(0,10),R=new Date(M);R.setDate(R.getDate()-6);const V=R.toISOString().slice(0,10),a=ue({start:V,end:P,status:[],channel:"",storeCode:"",campaignId:"",riskTag:[],page:1,pageSize:20}),q=[{value:"pending",label:"待提交"},{value:"under_review",label:"待审核"}],B=["wechat","h5","scan","api"],L=[20,50,100,200],r=d([]),F=d(0),$=d(null),c=d(!1),b=d(""),D=d(""),p=ue(new Set),h=A(()=>Array.from(p)),ce=A(()=>r.value.length>0&&r.value.every(l=>p.has(l.order_id))),G=d(!1),g=d(null),x=d("approve"),y=d(""),Q=d(!1),T=d("approve"),m=d(""),N=d(null),v=d(null),Y=d(!1),U=d(""),H=A(()=>Math.max(1,Math.ceil(F.value/a.pageSize))),pe=new Intl.NumberFormat("zh-CN",{style:"currency",currency:"CNY",minimumFractionDigits:2}),_e=new Intl.DateTimeFormat("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),ge={pending:"待提交",auto_reject:"自动拒绝",under_review:"待审核",approved:"已通过",rejected:"已驳回",settled:"已结算"};function fe(l){return l?ge[l]||l:"-"}function X(l){return l==null?"-":pe.format(l)}function Z(l){if(!l)return"-";try{return _e.format(new Date(l))}catch{return l}}const be=A(()=>{var l,t;return((t=(l=v.value)==null?void 0:l.audits)==null?void 0:t.slice(0,3))??[]});function he(){a.start=V,a.end=P,a.status=[],a.channel="",a.storeCode="",a.campaignId="",a.riskTag=[],a.page=1,a.pageSize=20,E()}function ye(){a.page=1,E()}function ee(l){const t=Math.min(Math.max(l,1),H.value);a.page!==t&&(a.page=t,E())}function me(l){const t=l.target,u=Number(t.value);a.pageSize!==u&&(a.pageSize=u,a.page=1,E())}function ke(l,t){t.target.checked?p.add(l):p.delete(l)}function we(l){l.target.checked?r.value.forEach(u=>p.add(u.order_id)):r.value.forEach(u=>p.delete(u.order_id))}function Ce(){p.clear()}function te(l){N.value=l.order_id,ze(l.order_id)}function Se(l){z.push({path:`/orders/${l}`})}function le(l,t){g.value=l,x.value=t,y.value="",G.value=!0}function se(){G.value=!1,y.value="",g.value=null}function ae(l){T.value=l,m.value="",Q.value=!0}function ne(){Q.value=!1,m.value=""}function Me(l){return l==="approve"?"approved":"rejected"}async function xe(){if(!(!g.value||y.value.length<5)){c.value=!0,b.value="";try{const l={action:x.value,note:y.value,reviewer_id:"demo-reviewer"},u=(await W.reviewOrder(g.value.order_id,l)).new_status??Me(x.value);r.value=r.value.filter(_=>{var k;return _.order_id!==((k=g.value)==null?void 0:k.order_id)}),p.delete(g.value.order_id),D.value=`订单 ${g.value.order_id} 已${x.value==="approve"?"通过":"驳回"}。`,N.value===g.value.order_id&&(v.value=v.value?{...v.value,status:u}:v.value),se()}catch(l){b.value=(l==null?void 0:l.message)||"提交审核失败，请稍后重试。"}finally{c.value=!1}}}async function Ie(){if(!(m.value.length<5||h.value.length===0)){c.value=!0,b.value="";try{const l={ids:h.value,action:T.value,note:m.value},t=await W.batchReviewOrders(l),u=new Set(t.processed_ids??l.ids);r.value=r.value.filter(_=>!u.has(_.order_id)),l.ids.forEach(_=>p.delete(_)),D.value=`批量${T.value==="approve"?"通过":"驳回"} ${u.size} 条订单成功。`,ne()}catch(l){b.value=(l==null?void 0:l.message)||"批量审核失败，请稍后重试。"}finally{c.value=!1}}}async function Oe(){try{$.value=await re.getReviewStats(a.start||void 0,a.end||void 0)}catch{}}function oe(l,t="加载待审核订单失败，请稍后重试。"){return l?l.includes("Failed to fetch")||l.includes("NetworkError")?"无法连接到审核接口，请确认 Mock 服务已启动或网络可用。":l:t}async function E(){c.value=!0,b.value="",D.value="";try{const l=a.status.length?a.status:void 0,t=a.channel?[a.channel]:void 0,u=a.riskTag.length?a.riskTag:void 0,_=await re.listReviewOrders(a.start||void 0,a.end||void 0,l,t,a.storeCode||void 0,a.campaignId||void 0,u,a.page,a.pageSize);r.value=_.items??[],F.value=_.total??0;const k=new Set(r.value.map(w=>w.order_id));Array.from(p).forEach(w=>{k.has(w)||p.delete(w)}),r.value.length&&!N.value&&te(r.value[0])}catch(l){b.value=oe(l==null?void 0:l.message),r.value=[],F.value=0}finally{c.value=!1}}async function ze(l){Y.value=!0,U.value="";try{v.value=await W.getOrderDetail(l)}catch(t){U.value=oe(t==null?void 0:t.message,"加载订单详情失败。")}finally{Y.value=!1}}return $e(()=>{Oe(),E()}),(l,t)=>{var u,_,k,w;return i(),o("section",Pe,[e("header",Ve,[t[19]||(t[19]=e("div",null,[e("h1",{class:"review__title"},"审核工作台"),e("p",{class:"review__subtitle"},"集中处理待审核订单，支持快捷复核与详情查看。")],-1)),$.value?(i(),o("div",Fe,[e("div",Ne,[t[16]||(t[16]=e("span",{class:"stat-card__label"},"待审核总数",-1)),e("strong",Ue,n($.value.pending_total),1)]),e("div",je,[t[17]||(t[17]=e("span",{class:"stat-card__label"},"今日已处理",-1)),e("strong",Ae,n($.value.processed_today),1)]),e("div",qe,[t[18]||(t[18]=e("span",{class:"stat-card__label"},"平均耗时(秒)",-1)),e("strong",Be,n($.value.avg_time_sec),1)])])):I("",!0)]),e("form",{class:"filters",onSubmit:De(ye,["prevent"])},[e("fieldset",Le,[t[29]||(t[29]=e("legend",null,"筛选条件",-1)),e("div",Ge,[e("label",Qe,[t[20]||(t[20]=e("span",null,"开始日期",-1)),f(e("input",{class:"input",type:"date","onUpdate:modelValue":t[0]||(t[0]=s=>a.start=s)},null,512),[[O,a.start]])]),e("label",Ye,[t[21]||(t[21]=e("span",null,"结束日期",-1)),f(e("input",{class:"input",type:"date","onUpdate:modelValue":t[1]||(t[1]=s=>a.end=s)},null,512),[[O,a.end]])]),e("label",He,[t[22]||(t[22]=e("span",null,"状态",-1)),f(e("select",{class:"input",multiple:"","onUpdate:modelValue":t[2]||(t[2]=s=>a.status=s)},[(i(),o(C,null,S(q,s=>e("option",{key:s.value,value:s.value},n(s.label),9,Je)),64))],512),[[J,a.status]])]),e("label",Ke,[t[24]||(t[24]=e("span",null,"渠道",-1)),f(e("select",{class:"input","onUpdate:modelValue":t[3]||(t[3]=s=>a.channel=s)},[t[23]||(t[23]=e("option",{value:""},"全部",-1)),(i(),o(C,null,S(B,s=>e("option",{key:s,value:s},n(s),9,We)),64))],512),[[J,a.channel]])]),e("label",Xe,[t[25]||(t[25]=e("span",null,"门店编码",-1)),f(e("input",{class:"input",type:"text","onUpdate:modelValue":t[4]||(t[4]=s=>a.storeCode=s),placeholder:"如 S001"},null,512),[[O,a.storeCode,void 0,{trim:!0}]])]),e("label",Ze,[t[26]||(t[26]=e("span",null,"活动 ID",-1)),f(e("input",{class:"input",type:"text","onUpdate:modelValue":t[5]||(t[5]=s=>a.campaignId=s),placeholder:"如 C001"},null,512),[[O,a.campaignId,void 0,{trim:!0}]])]),e("label",et,[t[28]||(t[28]=e("span",null,"风控标签",-1)),f(e("select",{class:"input",multiple:"","onUpdate:modelValue":t[6]||(t[6]=s=>a.riskTag=s)},[...t[27]||(t[27]=[e("option",{value:"high"},"高风险",-1),e("option",{value:"medium"},"中风险",-1),e("option",{value:"low"},"低风险",-1)])],512),[[J,a.riskTag]])])]),e("div",tt,[e("button",{type:"submit",class:"btn",disabled:c.value},"应用筛选",8,lt),e("button",{type:"button",class:"btn btn--ghost",onClick:he,disabled:c.value},"重置",8,st)])])],32),e("div",at,[e("section",nt,[h.value.length?(i(),o("div",ot,[e("span",null,"已选 "+n(h.value.length)+" 条",1),e("div",it,[e("button",{type:"button",class:"btn",onClick:t[7]||(t[7]=s=>ae("approve"))},"批量通过"),e("button",{type:"button",class:"btn btn--danger",onClick:t[8]||(t[8]=s=>ae("reject"))},"批量驳回"),e("button",{type:"button",class:"btn btn--ghost",onClick:Ce},"清空")])])):I("",!0),e("div",ut,[e("table",null,[e("thead",null,[e("tr",null,[e("th",dt,[e("input",{type:"checkbox",checked:ce.value,onChange:t[9]||(t[9]=s=>we(s))},null,40,rt)]),t[30]||(t[30]=e("th",null,"时间",-1)),t[31]||(t[31]=e("th",null,"订单号",-1)),t[32]||(t[32]=e("th",null,"用户",-1)),t[33]||(t[33]=e("th",null,"手机号",-1)),t[34]||(t[34]=e("th",null,"门店",-1)),t[35]||(t[35]=e("th",null,"活动",-1)),t[36]||(t[36]=e("th",null,"金额",-1)),t[37]||(t[37]=e("th",null,"风控",-1)),t[38]||(t[38]=e("th",{class:"actions-col"},"操作",-1))])]),c.value?(i(),o("tbody",vt,[(i(),o(C,null,S(5,s=>e("tr",{key:`loading-${s}`},[...t[39]||(t[39]=[e("td",{colspan:10},[e("div",{class:"skeleton"})],-1)])])),64))])):r.value.length?(i(),o("tbody",ct,[(i(!0),o(C,null,S(r.value,s=>(i(),o("tr",{key:s.order_id,class:K({"is-active":N.value===s.order_id})},[e("td",pt,[e("input",{type:"checkbox",checked:p.has(s.order_id),onChange:j=>ke(s.order_id,j)},null,40,_t)]),e("td",null,n(Z(s.created_at)),1),e("td",null,[e("button",{type:"button",class:"link-btn",onClick:j=>te(s)},n(s.order_id),9,gt)]),e("td",null,n(s.user_name),1),e("td",null,n(s.phone),1),e("td",null,n(s.store_name),1),e("td",null,n(s.campaign_name),1),e("td",null,n(X(s.amount)),1),e("td",null,[s.risk_flag?(i(),o("span",ft,"命中")):(i(),o("span",bt,"-"))]),e("td",ht,[e("div",yt,[e("button",{type:"button",class:"link-btn",onClick:j=>le(s,"approve")},"通过",8,mt),e("button",{type:"button",class:"link-btn",onClick:j=>le(s,"reject")},"驳回",8,kt)])])],2))),128))])):(i(),o("tbody",wt,[...t[40]||(t[40]=[e("tr",null,[e("td",{colspan:10,class:"placeholder"},"暂无待审核订单")],-1)])]))])]),e("footer",Ct,[e("button",{type:"button",class:"btn btn--ghost",disabled:a.page<=1||c.value,onClick:t[10]||(t[10]=s=>ee(a.page-1))},"上一页",8,St),e("span",null,"第 "+n(a.page)+" / "+n(H.value)+" 页",1),e("button",{type:"button",class:"btn btn--ghost",disabled:a.page>=H.value||c.value,onClick:t[11]||(t[11]=s=>ee(a.page+1))},"下一页",8,Mt),e("label",xt,[t[41]||(t[41]=e("span",null,"每页",-1)),e("select",{class:"input",value:a.pageSize,onChange:t[12]||(t[12]=s=>me(s))},[(i(),o(C,null,S(L,s=>e("option",{key:s,value:s},n(s),9,Ot)),64))],40,It)]),e("span",null,"共 "+n(F.value)+" 条",1)])]),e("aside",zt,[Y.value?(i(),o("div",Rt,"加载详情...")):U.value?(i(),o("div",$t,n(U.value),1)):v.value?(i(),o("div",Dt,[e("header",Tt,[e("h2",null,"订单 "+n(v.value.order_id),1),e("span",{class:"status-tag","data-status":v.value.status},n(fe(v.value.status)),9,Et)]),e("dl",null,[e("div",null,[t[42]||(t[42]=e("dt",null,"金额",-1)),e("dd",null,n(X(v.value.amount)),1)]),e("div",null,[t[43]||(t[43]=e("dt",null,"推广人",-1)),e("dd",null,n(((u=v.value.user)==null?void 0:u.name)||"-"),1)]),e("div",null,[t[44]||(t[44]=e("dt",null,"手机号",-1)),e("dd",null,n(((_=v.value.user)==null?void 0:_.phone)||"-"),1)]),e("div",null,[t[45]||(t[45]=e("dt",null,"风控命中",-1)),e("dd",null,n((((k=v.value.risk_hits)==null?void 0:k.length)||0)>0?"是":"否"),1)])]),t[46]||(t[46]=e("h3",null,"最新日志",-1)),e("ul",Pt,[(i(!0),o(C,null,S(be.value,s=>(i(),o("li",{key:s.time},[e("span",null,n(Z(s.time)),1),e("span",null,n(s.actor),1),e("span",null,n(s.action),1)]))),128))]),e("button",{type:"button",class:"btn btn--ghost",onClick:t[13]||(t[13]=s=>Se(v.value.order_id))},"查看详情页")])):(i(),o("p",Vt,"请选择列表中的订单以查看详情。"))])]),b.value?(i(),o("p",Ft,n(b.value),1)):D.value?(i(),o("p",Nt,n(D.value),1)):I("",!0),G.value?(i(),o("div",Ut,[e("div",jt,[e("header",null,[e("h2",null,n(x.value==="approve"?"通过订单":"驳回订单"),1)]),e("section",At,[e("p",null,"订单号："+n((w=g.value)==null?void 0:w.order_id),1),e("label",qt,[t[47]||(t[47]=e("span",null,"备注（至少 5 个字符）",-1)),f(e("textarea",{class:"textarea","onUpdate:modelValue":t[14]||(t[14]=s=>y.value=s),rows:"4",placeholder:"请输入备注"},null,512),[[O,y.value,void 0,{trim:!0}]])])]),e("footer",Bt,[e("button",{type:"button",class:"btn btn--ghost",onClick:se},"取消"),e("button",{type:"button",class:K(["btn",{"btn--danger":x.value==="reject"}]),disabled:y.value.length<5||c.value,onClick:xe}," 确认提交 ",10,Lt)])])])):I("",!0),Q.value?(i(),o("div",Gt,[e("div",Qt,[e("header",null,[e("h2",null,"批量"+n(T.value==="approve"?"通过":"驳回")+" "+n(h.value.length)+" 条订单",1)]),e("section",Yt,[t[49]||(t[49]=e("p",{class:"modal__hint"},"将处理以下订单（最多展示前 3 条）：",-1)),e("ul",Ht,[(i(!0),o(C,null,S(h.value.slice(0,3),s=>(i(),o("li",{key:s},n(s),1))),128)),h.value.length>3?(i(),o("li",Jt,"... 等 "+n(h.value.length)+" 条",1)):I("",!0)]),e("label",Kt,[t[48]||(t[48]=e("span",null,"备注",-1)),f(e("textarea",{class:"textarea","onUpdate:modelValue":t[15]||(t[15]=s=>m.value=s),rows:"4",placeholder:"请输入批量审核备注（至少 5 个字符）"},null,512),[[O,m.value,void 0,{trim:!0}]])])]),e("footer",Wt,[e("button",{type:"button",class:"btn btn--ghost",onClick:ne},"取消"),e("button",{type:"button",class:K(["btn",{"btn--danger":T.value==="reject"}]),disabled:m.value.length<5||c.value,onClick:Ie}," 确认提交 ",10,Xt)])])])):I("",!0)])}}}),sl=Ee(Zt,[["__scopeId","data-v-6190f6f1"]]);export{sl as default};
