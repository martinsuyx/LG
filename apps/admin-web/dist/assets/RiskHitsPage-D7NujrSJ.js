import{d as Ne,a as J,r as m,c as T,o as ze,b as u,e as t,f as H,A as f,B as o,t as a,i as k,v as F,j as R,F as M,h as O,H as Fe,k as Q,q as r,s as c,E as Me,_ as Oe}from"./index-DvtP9USg.js";import{B as b}from"./Button-BaguUGDy.js";import{M as de}from"./Modal-CtEdl0zk.js";import{T as Be}from"./Table-BsZuLW91.js";import{P as $e}from"./Pagination-3ermIvaY.js";import{R as B}from"./risk-DnqpjeeB.js";const Re={class:"risk-hits"},Ie={class:"risk-hits__header"},Ke={class:"risk-hits__actions"},je={key:0,class:"risk-hits__summary","aria-label":"命中统计"},qe={class:"summary-card"},Ge={class:"summary-card"},Je={class:"summary-card"},Qe={class:"summary-card summary-card--critical"},Ye=["disabled"],We=["disabled"],Xe=["disabled"],Ze=["value"],et=["disabled"],tt=["value"],lt=["disabled"],st={class:"filters__keyword"},it=["disabled"],at={class:"filters__actions"},nt={class:"risk-hits__content"},ot={class:"risk-hits__table",role:"region","aria-label":"命中列表"},rt=["value","checked","onChange"],ut=["data-level"],dt={class:"entity-cell"},vt=["data-status"],ct={key:0,class:"bulk-select"},pt=["checked","indeterminate"],_t={key:0,class:"bulk-select__count"},mt={key:0,class:"risk-hits__drawer","aria-label":"命中详情"},ft={class:"drawer__header"},yt={key:0,class:"drawer__body"},gt={key:1,class:"drawer__body"},ht={class:"drawer-section"},kt={class:"drawer-grid"},bt=["data-status"],wt={class:"drawer-section"},Ct={class:"context-block"},Vt={class:"drawer-section"},Et={class:"evidence-list"},Tt={class:"evidence-type"},Ht={class:"evidence-text"},St={class:"drawer-section"},xt={class:"similar-list"},Dt={class:"similar-id"},Ut={class:"similar-score"},Lt={class:"drawer-actions"},At={key:2,class:"drawer__body"},Pt={key:1,class:"feedback"},Nt={key:2,class:"feedback feedback--error"},ve="2025-10-03",ce="2025-09-30",zt=Ne({__name:"RiskHitsPage",setup(Ft){const Y=[{hit_id:"H202510030001",hit_time:"2025-10-03T10:12:30+08:00",rule_code:"GEOFENCE_OUT",rule_name:"越界地理围栏",severity:"high",order_id:"O20251003001",entity:{phone:"138****0000",device_id:"DEV-9A7",store_id:"S001"},channel:"wechat",score:87.5,status:"new",ticket_id:null,operator:null,note:""},{hit_id:"H202510030014",hit_time:"2025-10-03T09:48:21+08:00",rule_code:"FREQ_APPLY",rule_name:"短期高频提交",severity:"medium",order_id:"O20251002999",entity:{id_number:"4401***********1234",device_id:"DEV-42C",ip:"183.23.12.9"},channel:"h5",score:74.2,status:"processing",ticket_id:"RTK-2025100008",operator:"林杉",note:"工单处理中"},{hit_id:"H202510021208",hit_time:"2025-10-02T22:05:18+08:00",rule_code:"DEVICE_BLACK",rule_name:"设备命中黑名单",severity:"critical",order_id:null,entity:{device_id:"DEV-BLK-888",promoter_id:"P0021"},channel:"api",score:95,status:"new",ticket_id:null,operator:null,note:""}],W={H202510030001:{hit_id:"H202510030001",context:{location:{lat:23.129,lng:113.264,distance_to_store_km:12.7},device:{device_id:"DEV-9A7",recent_orders_24h:5}},evidences:[{type:"text",content:"定位距离门店超过 10km"},{type:"stat",content:"同设备 24 小时内触发该规则 3 次"}],similar_hits:[{hit_id:"H202510020123",time:"2025-10-02T11:20:00+08:00",rule_code:"GEOFENCE_OUT",score:83.2},{hit_id:"H202510010456",time:"2025-10-01T15:02:00+08:00",rule_code:"GEOFENCE_OUT",score:80.1}]},H202510030014:{hit_id:"H202510030014",context:{submission:{count_1h:6,count_24h:15,channel:"h5"},user:{id_number:"4401***********1234",phone:"138****0001"}},evidences:[{type:"stat",content:"近 1 小时提交 6 笔，高于阈值 3"},{type:"text",content:"IP 与常驻城市不一致"}],similar_hits:[{hit_id:"H202510020201",time:"2025-10-02T18:21:00+08:00",rule_code:"FREQ_APPLY",score:76.4}]},H202510021208:{hit_id:"H202510021208",context:{device:{device_id:"DEV-BLK-888",blacklist_source:"国家名单库",related_users:12},account:{promoter_id:"P0021",promoter_name:"渠道-深圳A组",previous_risk_hits:5}},evidences:[{type:"text",content:"设备指纹命中高危黑名单库"},{type:"stat",content:"该设备近 24 小时发起 12 次请求"}],similar_hits:[{hit_id:"H202510021045",time:"2025-10-02T20:14:00+08:00",rule_code:"DEVICE_BLACK",score:94.5}]}},i=J({start:ce,end:ve,severity:"",status:"",channel:"",keyword:"",page:1,page_size:10,sort_key:"hit_time",sort_order:"desc"}),pe=[{value:"low",label:"低"},{value:"medium",label:"中"},{value:"high",label:"高"},{value:"critical",label:"致命"}],_e=[{value:"new",label:"未处理"},{value:"processing",label:"处理中"},{value:"resolved",label:"已处理"},{value:"ignored",label:"已忽略"}],p=m([]),I=m(0),_=m(!1),n=m([]),K=m(!1),V=m(null),d=T(()=>p.value.find(l=>l.hit_id===V.value)||null),$=J({}),j=m(!1),U=m(!1),E=m(""),L=m(!1),w=J({priority:"normal",note:""}),y=m(!1),A=m(""),S=m(""),me=[{key:"select",title:"",width:"3rem"},{key:"hit_time",title:"命中时间",sortable:!0,width:"10rem"},{key:"rule_name",title:"规则"},{key:"severity",title:"等级",width:"6rem"},{key:"order_id",title:"关联订单",width:"8rem"},{key:"entity",title:"主体摘要",width:"14rem"},{key:"channel",title:"渠道",width:"6rem"},{key:"score",title:"风险得分",sortable:!0,width:"7rem"},{key:"status",title:"状态",width:"7rem"},{key:"ticket_id",title:"工单号",width:"8rem"},{key:"operator",title:"处理人",width:"6rem"},{key:"note",title:"备注",width:"10rem"}],P=T(()=>{const l={total:p.value.length,new:0,processing:0,high:0};return p.value.forEach(e=>{e.status==="new"&&(l.new+=1),e.status==="processing"&&(l.processing+=1),(e.severity==="high"||e.severity==="critical")&&(l.high+=1)}),l}),X=T(()=>Math.max(1,Math.ceil(I.value/(i.page_size||10)))),N=T(()=>V.value?$[V.value]:null),x=T(()=>p.value.map(l=>l.hit_id)),fe=T(()=>x.value.length>0&&x.value.every(l=>n.value.includes(l))),ye=T(()=>{const l=x.value.filter(e=>n.value.includes(e)).length;return l>0&&l<x.value.length});ze(()=>{D()});async function D(){_.value=!0;try{const e=await B.listHits({...i})??{},v=Array.isArray(e.items)?e.items:[];v.length?(p.value=v,I.value=typeof e.total=="number"?e.total:v.length):(p.value=Y,I.value=Y.length),n.value=n.value.filter(g=>p.value.some(C=>C.hit_id===g)),V.value&&!p.value.some(g=>g.hit_id===V.value)&&Z()}catch(l){h(l.message||"加载命中列表失败")}finally{_.value=!1}}function ge(){i.page=1,D()}function he(){i.start=ce,i.end=ve,i.severity="",i.status="",i.channel="",i.keyword="",i.page=1,i.page_size=10,i.sort_key="hit_time",i.sort_order="desc",D()}function ke(l){i.page=l,D()}function be(l){i.page_size=l,i.page=1,D()}function we(l,e){(l==="hit_time"||l==="score"||l==="severity")&&(i.sort_key=l,i.sort_order=e,D())}function Ce(l,e){e.target.checked?n.value.includes(l)||(n.value=[...n.value,l]):n.value=n.value.filter(g=>g!==l)}function Ve(l){if(l.target.checked){const v=new Set([...n.value,...x.value]);n.value=Array.from(v)}else n.value=n.value.filter(v=>!x.value.includes(v))}function Ee(l){return n.value.includes(l)}async function Te(l){V.value=l.hit_id,K.value=!0,await He(l.hit_id)}function Z(){K.value=!1,V.value=null}async function He(l){if(!$[l]){j.value=!0;try{const e=await B.getHitDetail(l);e?$[l]=e:W[l]&&($[l]=W[l])}catch(e){h(e.message||"加载详情失败")}finally{j.value=!1}}}function Se(){n.value.length&&(E.value="",U.value=!0)}async function ee(){if(!n.value.length){h("请选择需要忽略的记录");return}if(!E.value||E.value.length<5){h("备注至少需要 5 个字符");return}y.value=!0;try{await B.batchIgnore({ids:n.value,note:E.value}),p.value=p.value.map(l=>n.value.includes(l.hit_id)?{...l,status:"ignored",note:E.value,operator:"当前用户"}:l),G(`已忽略 ${n.value.length} 条命中`),n.value=[],U.value=!1}catch(l){h(l.message||"忽略失败")}finally{y.value=!1}}function xe(){if(!d.value){h("请选择需要创建工单的命中");return}w.priority="normal",w.note="",L.value=!0}async function te(){if(!d.value){h("请选择命中记录");return}y.value=!0;try{const l=await B.createTicket({hit_id:d.value.hit_id,priority:w.priority,note:w.note||void 0});p.value=p.value.map(e=>{var v;return e.hit_id===((v=d.value)==null?void 0:v.hit_id)?{...e,status:"processing",ticket_id:l.ticket_id}:e}),d.value&&(d.value.status="processing",d.value.ticket_id=l.ticket_id),G(`已创建工单：${l.ticket_id}`),L.value=!1}catch(l){h(l.message||"创建工单失败")}finally{y.value=!1}}async function De(){y.value=!0;try{const l=await B.exportHits({...i});G(`导出任务已创建：${l.export_id}`)}catch(l){h(l.message||"导出失败")}finally{y.value=!1}}function Ue(l){const v=Object.entries(l).slice(0,3).map(([g,C])=>[g,typeof C=="object"?JSON.stringify(C):String(C)]);return Object.fromEntries(v)}function Le(l){try{return JSON.stringify(l,null,2)}catch{return String(l)}}function Ae(l){switch(l){case"stat":return"统计";case"image":return"图片";case"text":default:return"文本"}}function Pe(l){switch(l){case"low":return"低";case"medium":return"中";case"high":return"高";case"critical":return"致命";default:return l}}function le(l){switch(l){case"new":return"未处理";case"processing":return"处理中";case"resolved":return"已处理";case"ignored":return"已忽略";default:return l}}function q(l){if(!l)return"—";const e=new Date(l);return Number.isNaN(e.getTime())?l:`${e.toLocaleDateString()} ${e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}`}function G(l){A.value=l,S.value="",window.setTimeout(()=>{A.value===l&&(A.value="")},4e3)}function h(l){S.value=l,window.setTimeout(()=>{S.value===l&&(S.value="")},5e3)}return(l,e)=>{var v,g,C,se,ie,ae,ne,oe,re;return r(),u("section",Re,[t("header",Ie,[e[18]||(e[18]=t("div",null,[t("h1",{class:"risk-hits__title"},"风控命中列表"),t("p",{class:"risk-hits__subtitle"},"筛选命中记录，查看上下文并快速发起处置。")],-1)),t("div",Ke,[f(b,{size:"sm",variant:"ghost",disabled:_.value,onClick:De},{default:o(()=>[...e[16]||(e[16]=[c("导出当前视图",-1)])]),_:1},8,["disabled"]),f(b,{size:"sm",variant:"secondary",disabled:!n.value.length,onClick:Se},{default:o(()=>[...e[17]||(e[17]=[c("批量忽略",-1)])]),_:1},8,["disabled"])])]),P.value.total?(r(),u("section",je,[t("article",qe,[e[19]||(e[19]=t("h3",null,"命中总数",-1)),t("strong",null,a(P.value.total),1)]),t("article",Ge,[e[20]||(e[20]=t("h3",null,"未处理",-1)),t("strong",null,a(P.value.new),1)]),t("article",Je,[e[21]||(e[21]=t("h3",null,"处理中",-1)),t("strong",null,a(P.value.processing),1)]),t("article",Qe,[e[22]||(e[22]=t("h3",null,"高危及以上",-1)),t("strong",null,a(P.value.high),1)])])):H("",!0),t("form",{class:"risk-hits__filters",onSubmit:Q(ge,["prevent"])},[t("label",null,[e[23]||(e[23]=t("span",null,"开始日期",-1)),k(t("input",{type:"date","onUpdate:modelValue":e[0]||(e[0]=s=>i.start=s),disabled:_.value,required:""},null,8,Ye),[[F,i.start]])]),t("label",null,[e[24]||(e[24]=t("span",null,"结束日期",-1)),k(t("input",{type:"date","onUpdate:modelValue":e[1]||(e[1]=s=>i.end=s),disabled:_.value,required:""},null,8,We),[[F,i.end]])]),t("label",null,[e[26]||(e[26]=t("span",null,"等级",-1)),k(t("select",{"onUpdate:modelValue":e[2]||(e[2]=s=>i.severity=s),disabled:_.value},[e[25]||(e[25]=t("option",{value:""},"全部",-1)),(r(),u(M,null,O(pe,s=>t("option",{key:s.value,value:s.value},a(s.label),9,Ze)),64))],8,Xe),[[R,i.severity]])]),t("label",null,[e[28]||(e[28]=t("span",null,"状态",-1)),k(t("select",{"onUpdate:modelValue":e[3]||(e[3]=s=>i.status=s),disabled:_.value},[e[27]||(e[27]=t("option",{value:""},"全部",-1)),(r(),u(M,null,O(_e,s=>t("option",{key:s.value,value:s.value},a(s.label),9,tt)),64))],8,et),[[R,i.status]])]),t("label",null,[e[30]||(e[30]=t("span",null,"渠道",-1)),k(t("select",{"onUpdate:modelValue":e[4]||(e[4]=s=>i.channel=s),disabled:_.value},[...e[29]||(e[29]=[Fe('<option value="" data-v-3630fd0b>全部</option><option value="wechat" data-v-3630fd0b>微信</option><option value="h5" data-v-3630fd0b>H5</option><option value="scan" data-v-3630fd0b>扫码</option><option value="api" data-v-3630fd0b>API</option>',5)])],8,lt),[[R,i.channel]])]),t("label",st,[e[31]||(e[31]=t("span",null,"关键词",-1)),k(t("input",{type:"search","onUpdate:modelValue":e[5]||(e[5]=s=>i.keyword=s),placeholder:"命中ID / 规则 / 订单",disabled:_.value},null,8,it),[[F,i.keyword,void 0,{trim:!0}]])]),t("div",at,[f(b,{size:"sm",type:"submit",loading:_.value},{default:o(()=>[...e[32]||(e[32]=[c("应用筛选",-1)])]),_:1},8,["loading"]),f(b,{size:"sm",variant:"ghost",type:"button",disabled:_.value,onClick:he},{default:o(()=>[...e[33]||(e[33]=[c("重置",-1)])]),_:1},8,["disabled"])])],32),t("div",nt,[t("section",ot,[f(Be,{columns:me,rows:p.value,loading:_.value,"row-key":s=>s.hit_id,"default-sort-key":"hit_time","default-sort-order":"desc",onRowClick:Te,onSortChange:we},{"cell:select":o(({row:s})=>[t("input",{type:"checkbox",value:s.hit_id,checked:Ee(s.hit_id),onChange:z=>Ce(s.hit_id,z),"aria-label":"选择命中"},null,40,rt)]),"cell:hit_time":o(({row:s})=>[c(a(q(s.hit_time)),1)]),"cell:severity":o(({row:s})=>[t("span",{class:"severity-chip","data-level":s.severity},a(Pe(s.severity)),9,ut)]),"cell:entity":o(({row:s})=>[t("div",dt,[(r(!0),u(M,null,O(Ue(s.entity),(z,ue)=>(r(),u("span",{key:`${s.hit_id}-${ue}`},[t("strong",null,a(ue)+"：",1),c(a(z),1)]))),128))])]),"cell:status":o(({row:s})=>[t("span",{class:"status-chip","data-status":s.status},a(le(s.status)),9,vt)]),"cell:note":o(({row:s})=>[c(a(s.note||"—"),1)]),empty:o(()=>[c(a(_.value?"加载中…":"暂无命中记录"),1)]),pagination:o(()=>[X.value>1?(r(),Me($e,{key:0,page:i.page,pages:X.value,"page-size":i.page_size,"onUpdate:page":ke,"onUpdate:pageSize":be},null,8,["page","pages","page-size"])):H("",!0)]),_:1},8,["rows","loading","row-key"]),p.value.length?(r(),u("div",ct,[t("label",null,[t("input",{type:"checkbox",checked:fe.value,indeterminate:ye.value,onChange:e[6]||(e[6]=s=>Ve(s))},null,40,pt),e[34]||(e[34]=t("span",null,"本页全选",-1))]),n.value.length?(r(),u("span",_t,"已选择 "+a(n.value.length)+" 条",1)):H("",!0)])):H("",!0)]),K.value?(r(),u("aside",mt,[t("header",ft,[t("div",null,[e[35]||(e[35]=t("h2",null,"命中详情",-1)),t("p",null,a((v=d.value)==null?void 0:v.rule_name)+" · "+a((g=d.value)==null?void 0:g.hit_id),1)]),t("button",{class:"drawer__close",type:"button","aria-label":"关闭",onClick:Z},"×")]),j.value?(r(),u("div",yt,[...e[36]||(e[36]=[t("p",{class:"drawer__placeholder"},"详情加载中…",-1)])])):N.value?(r(),u("div",gt,[t("section",ht,[e[43]||(e[43]=t("h3",null,"基本信息",-1)),t("dl",kt,[t("div",null,[e[37]||(e[37]=t("dt",null,"命中时间",-1)),t("dd",null,a(q((C=d.value)==null?void 0:C.hit_time)),1)]),t("div",null,[e[38]||(e[38]=t("dt",null,"规则编码",-1)),t("dd",null,a((se=d.value)==null?void 0:se.rule_code),1)]),t("div",null,[e[39]||(e[39]=t("dt",null,"风险得分",-1)),t("dd",null,a((ie=d.value)==null?void 0:ie.score),1)]),t("div",null,[e[40]||(e[40]=t("dt",null,"状态",-1)),t("dd",null,[t("span",{class:"status-chip","data-status":((ae=d.value)==null?void 0:ae.status)||"new"},a(le(((ne=d.value)==null?void 0:ne.status)||"new")),9,bt)])]),t("div",null,[e[41]||(e[41]=t("dt",null,"关联订单",-1)),t("dd",null,a(((oe=d.value)==null?void 0:oe.order_id)||"—"),1)]),t("div",null,[e[42]||(e[42]=t("dt",null,"关联工单",-1)),t("dd",null,a(((re=d.value)==null?void 0:re.ticket_id)||"—"),1)])])]),t("section",wt,[e[44]||(e[44]=t("h3",null,"命中上下文",-1)),t("div",Ct,[t("pre",null,a(Le(N.value.context)),1)])]),t("section",Vt,[e[45]||(e[45]=t("h3",null,"证据",-1)),t("ul",Et,[(r(!0),u(M,null,O(N.value.evidences,(s,z)=>(r(),u("li",{key:`${N.value.hit_id}-evidence-${z}`},[t("span",Tt,a(Ae(s.type)),1),t("span",Ht,a(s.content),1)]))),128))])]),t("section",St,[e[46]||(e[46]=t("h3",null,"相似命中",-1)),t("ul",xt,[(r(!0),u(M,null,O(N.value.similar_hits,s=>(r(),u("li",{key:s.hit_id},[t("span",Dt,a(s.hit_id),1),t("span",null,a(q(s.time)),1),t("span",null,a(s.rule_code),1),t("span",Ut,"得分 "+a(s.score),1)]))),128))])]),t("div",Lt,[f(b,{size:"sm",variant:"secondary",onClick:xe},{default:o(()=>[...e[47]||(e[47]=[c("创建工单",-1)])]),_:1})])])):(r(),u("div",At,[...e[48]||(e[48]=[t("p",{class:"drawer__placeholder"},"请选择一个命中查看详情",-1)])]))])):H("",!0)]),A.value?(r(),u("p",Pt,a(A.value),1)):H("",!0),S.value?(r(),u("p",Nt,a(S.value),1)):H("",!0),f(de,{modelValue:U.value,"onUpdate:modelValue":e[10]||(e[10]=s=>U.value=s),onConfirm:ee},{title:o(()=>[...e[49]||(e[49]=[c("批量忽略命中",-1)])]),footer:o(()=>[f(b,{variant:"secondary",onClick:e[9]||(e[9]=s=>U.value=!1),disabled:y.value},{default:o(()=>[...e[51]||(e[51]=[c("取消",-1)])]),_:1},8,["disabled"]),f(b,{variant:"primary",loading:y.value,onClick:ee},{default:o(()=>[...e[52]||(e[52]=[c("确认忽略",-1)])]),_:1},8,["loading"])]),default:o(()=>[t("form",{class:"modal-form",onSubmit:e[8]||(e[8]=Q(()=>{},["prevent"]))},[t("p",null,"已选择 "+a(n.value.length)+" 条记录，忽略操作需填写原因。",1),t("label",null,[e[50]||(e[50]=t("span",null,"备注（至少 5 字）",-1)),k(t("textarea",{"onUpdate:modelValue":e[7]||(e[7]=s=>E.value=s),rows:"3",placeholder:"说明忽略原因"},null,512),[[F,E.value,void 0,{trim:!0}]])])],32)]),_:1},8,["modelValue"]),f(de,{modelValue:L.value,"onUpdate:modelValue":e[15]||(e[15]=s=>L.value=s),onConfirm:te},{title:o(()=>[...e[53]||(e[53]=[c("创建风控工单",-1)])]),footer:o(()=>[f(b,{variant:"secondary",onClick:e[14]||(e[14]=s=>L.value=!1),disabled:y.value},{default:o(()=>[...e[57]||(e[57]=[c("取消",-1)])]),_:1},8,["disabled"]),f(b,{variant:"primary",loading:y.value,onClick:te,disabled:!d.value},{default:o(()=>[...e[58]||(e[58]=[c("提交工单",-1)])]),_:1},8,["loading","disabled"])]),default:o(()=>[t("form",{class:"modal-form",onSubmit:e[13]||(e[13]=Q(()=>{},["prevent"]))},[t("label",null,[e[55]||(e[55]=t("span",null,"优先级",-1)),k(t("select",{"onUpdate:modelValue":e[11]||(e[11]=s=>w.priority=s)},[...e[54]||(e[54]=[t("option",{value:"low"},"低",-1),t("option",{value:"normal"},"普通",-1),t("option",{value:"high"},"高",-1)])],512),[[R,w.priority]])]),t("label",null,[e[56]||(e[56]=t("span",null,"备注",-1)),k(t("textarea",{"onUpdate:modelValue":e[12]||(e[12]=s=>w.note=s),rows:"3",placeholder:"补充说明（可选）"},null,512),[[F,w.note,void 0,{trim:!0}]])])],32)]),_:1},8,["modelValue"])])}}}),Kt=Oe(zt,[["__scopeId","data-v-3630fd0b"]]);export{Kt as default};
