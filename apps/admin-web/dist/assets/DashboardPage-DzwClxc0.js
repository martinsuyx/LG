import{O as R,d as ba,u as va,r as g,a as pa,c as p,w as X,o as ma,b as d,e,f as b,t as n,g as i,F as m,h as y,i as w,v as F,j as Z,n as S,k as O,l as aa,m as A,p as ya,q as l,_ as fa}from"./index-DvtP9USg.js";import{r as U}from"./request-Bu45iIRO.js";class E{static getDashboardOverview(r,f,u="d",h,s,c,_="Asia/Shanghai"){return U(R,{method:"GET",url:"/api/v1/dashboard/overview",query:{start:r,end:f,granularity:u,company_id:h,city:s,channel:c,tz:_},errors:{400:"Invalid request parameters."}})}static getDashboardSeries(r="orders",f,u,h="d",s,c,_,D="Asia/Shanghai"){return U(R,{method:"GET",url:"/api/v1/dashboard/series",query:{metric:r,start:f,end:u,granularity:h,company_id:s,city:c,channel:_,tz:D},errors:{400:"Invalid request parameters."}})}static getDashboardCompare(r,f,u="d",h,s,c,_="Asia/Shanghai"){return U(R,{method:"GET",url:"/api/v1/dashboard/compare",query:{start:r,end:f,granularity:u,company_id:h,city:s,channel:c,tz:_},errors:{400:"Invalid request parameters."}})}}const ga={class:"dashboard"},ka={class:"dashboard__hero"},wa={class:"dashboard__title"},Da={class:"dashboard__subtitle"},$a={class:"dashboard__hero-actions"},Ca=["disabled"],qa={type:"button",class:"dashboard__action dashboard__action--ghost"},Ma={key:0,class:"dashboard__alerts"},Ia={class:"dashboard__section-head"},xa={class:"dashboard__section-title"},Fa={class:"dashboard__alert-list"},Sa=["data-level"],Ta={class:"dashboard__alert-content"},Va={class:"dashboard__alert-title"},za={key:0,class:"dashboard__alert-desc"},Na=["href"],Ra={class:"dashboard__filters-group"},Oa={class:"dashboard__filters-grid"},Aa={class:"dashboard__field"},Ua={class:"dashboard__field-label"},Ea={class:"dashboard__date-range"},La={class:"dashboard__field"},Pa={class:"dashboard__field-label"},Ka=["value"],Ba={class:"dashboard__field"},Ga={class:"dashboard__field-label"},ja={class:"dashboard__field"},Ha={class:"dashboard__field-label"},Wa={class:"dashboard__field"},Ya={class:"dashboard__field-label"},Qa=["value"],Ja={class:"dashboard__field-hint"},Xa={class:"dashboard__quick"},Za={class:"dashboard__field-label"},ae={class:"dashboard__quick-buttons"},ee=["onClick"],te=["onClick","onKeydown"],se={class:"dashboard__kpi-header"},oe={class:"dashboard__kpi-label"},re=["data-trend"],ne={key:0},de={key:1},le={key:2},ie={class:"dashboard__kpi-value"},ce={class:"dashboard__kpi-number"},_e={class:"dashboard__kpi-unit"},he={key:0,class:"dashboard__kpi-delta"},ue={key:0,class:"dashboard__empty"},be={class:"dashboard__chart-card"},ve={class:"dashboard__section-head"},pe={class:"dashboard__section-title"},me={class:"dashboard__section-subtitle"},ye={class:"dashboard__metric-switch"},fe=["onClick"],ge={key:0,class:"trend-chart",role:"img"},ke={class:"trend-chart__list"},we={class:"trend-chart__bars"},De=["title"],$e=["title"],Ce={class:"trend-chart__time"},qe={key:1,class:"dashboard__empty"},Me={key:0,class:"dashboard__chart-card"},Ie={class:"dashboard__section-head"},xe={class:"dashboard__section-title"},Fe={class:"dashboard__compare-table"},Se={scope:"col"},Te={scope:"col"},Ve={scope:"col"},ze={scope:"col"},Ne={scope:"row"},Re=["data-positive"],Oe={key:1,class:"dashboard__error",role:"alert"},Ae={key:2,class:"dashboard__loading","aria-live":"polite"},Ue=ba({__name:"DashboardPage",setup(ea){const{t:r}=va(),f=ya(),u=g("today"),h=g("orders"),s=pa({start:x(new Date),end:x(new Date),granularity:"d",companyId:"",city:"",channel:[],tz:"Asia/Shanghai"}),c=g(!1),_=g(""),D=g(null),L=g([]),P=g([]),ta=[{value:"d",label:"dashboard.granularity.d"},{value:"w",label:"dashboard.granularity.w"},{value:"m",label:"dashboard.granularity.m"}],sa=[{value:"today",label:"dashboard.filters.quickToday"},{value:"7d",label:"dashboard.filters.quick7d"},{value:"30d",label:"dashboard.filters.quick30d"}],oa=p(()=>[{value:"orders",label:r("dashboard.kpi.orders_today")},{value:"gmv",label:r("dashboard.kpi.settlement_today")},{value:"approval_rate",label:r("dashboard.kpi.approval_rate")}]),ra=p(()=>[{value:"wechat",label:r("dashboard.channel.wechat")},{value:"h5",label:r("dashboard.channel.h5")},{value:"scan",label:r("dashboard.channel.scan")},{value:"api",label:r("dashboard.channel.api")}]),K=p(()=>{var t;return((t=D.value)==null?void 0:t.alerts)??[]}),B=p(()=>{var t;return(((t=D.value)==null?void 0:t.kpis)??[]).map(o=>({...o,label:o.label||r(`dashboard.kpi.${o.key}`),formattedValue:_a(o),formattedDelta:ha(o),trend:o.trend??"flat"}))}),C=p(()=>L.value),G=p(()=>P.value),j=p(()=>{if(!C.value.length)return 1;let t=1;return C.value.forEach(o=>{t=Math.max(t,o.value??0,o.baseline_yesterday??0,o.baseline_lastweek??0)}),t||1}),T=p(()=>!s.start||!s.end?!0:s.start<=s.end);let V;X(()=>[s.start,s.end,s.granularity,s.companyId,s.city,s.channel.join(","),s.tz],()=>{T.value&&q()}),X(h,()=>{T.value&&q()}),ma(()=>{q(!0)});function q(t=!1){V&&window.clearTimeout(V),t?H():V=window.setTimeout(()=>{H()},150)}async function H(){if(!T.value){_.value=r("dashboard.errors.range");return}c.value=!0,_.value="";try{const[t,o,a]=await Promise.all([E.getDashboardOverview(s.start||void 0,s.end||void 0,s.granularity,k(s.companyId),k(s.city),s.channel.length?s.channel:void 0,s.tz),E.getDashboardSeries(h.value,s.start||void 0,s.end||void 0,s.granularity,k(s.companyId),k(s.city),s.channel.length?s.channel:void 0,s.tz),E.getDashboardCompare(s.start||void 0,s.end||void 0,s.granularity,k(s.companyId),k(s.city),s.channel.length?s.channel:void 0,s.tz)]);D.value=t,L.value=o.points,P.value=a.metrics}catch(t){console.error(t),_.value=r("dashboard.errors.load")}finally{c.value=!1}}function na(){q(!0)}function k(t){return t||void 0}function W(t){u.value=t;const o=new Date;let a=new Date;t==="7d"?a=J(o,-6):t==="30d"&&(a=J(o,-29)),s.start=x(a),s.end=x(o)}function da(){s.granularity="d",s.companyId="",s.city="",s.channel=[],W("today")}function Y(){u.value="custom"}function la(t){h.value=t}function z(t){t&&(t.startsWith("http")?window.open(t,"_blank"):f.push(t))}function N(t){if(!t||j.value===0)return"0%";const o=Math.max(t/j.value,0);return`${Math.round(o*100)}%`}function ia(t){const o=new Date(t);return Number.isNaN(o.getTime())?t:`${o.getMonth()+1}/${o.getDate()}`}function Q(t,o){return o==="gmv"?`${M.format(t)} 元`:o==="approval_rate"?`${$.format(t*100)}%`:`${I.format(t)} 笔`}function ca(t){const o=t.change>0?"+":t.change<0?"-":"",a=t.key==="gmv"?`${M.format(Math.abs(t.change))} 元`:t.key==="approval_rate"?`${$.format(Math.abs(t.change)*100)}%`:`${I.format(Math.abs(t.change))} 笔`,v=`${o}${a}`,ua=`${$.format(t.change_rate*100)}%`;return`${v} (${ua})`}const M=new Intl.NumberFormat("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}),$=new Intl.NumberFormat("zh-CN",{minimumFractionDigits:1,maximumFractionDigits:1}),I=new Intl.NumberFormat("zh-CN",{maximumFractionDigits:0});function _a(t){return t.unit==="%"?$.format(t.value):t.unit==="元"?M.format(t.value):I.format(t.value)}function ha(t){if(typeof t.delta=="number"){const o=t.delta>0?"+":t.delta<0?"-":"",a=t.unit==="元"?M.format(Math.abs(t.delta)):I.format(Math.abs(t.delta));return`${o}${a} ${t.unit}`}return typeof t.delta_rate=="number"?`${t.delta_rate>0?"+":""}${$.format(t.delta_rate*100)}%`:null}function J(t,o){const a=new Date(t);return a.setDate(a.getDate()+o),a}function x(t){const o=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),v=String(t.getDate()).padStart(2,"0");return`${o}-${a}-${v}`}return(t,o)=>(l(),d("section",ga,[e("header",ka,[e("div",null,[e("h1",wa,n(i(r)("dashboard.title")),1),e("p",Da,n(i(r)("dashboard.subtitle")),1)]),e("div",$a,[e("button",{type:"button",class:"dashboard__action",onClick:na,disabled:c.value},n(i(r)("dashboard.actions.refresh")),9,Ca),e("button",qa,n(i(r)("dashboard.actions.export")),1)])]),K.value.length?(l(),d("section",Ma,[e("header",Ia,[e("h2",xa,n(i(r)("dashboard.alertsTitle")),1)]),e("ul",Fa,[(l(!0),d(m,null,y(K.value,a=>(l(),d("li",{key:a.title,class:"dashboard__alert-card","data-level":a.level},[e("div",Ta,[e("span",Va,n(a.title),1),a.description?(l(),d("p",za,n(a.description),1)):b("",!0)]),a.action_link?(l(),d("a",{key:0,class:"dashboard__alert-link",href:a.action_link},n(i(r)("dashboard.alertsAction")),9,Na)):b("",!0)],8,Sa))),128))])])):b("",!0),e("form",{class:"dashboard__filters",onSubmit:o[6]||(o[6]=O(()=>{},["prevent"]))},[e("fieldset",Ra,[e("legend",null,n(i(r)("dashboard.filters.groupTitle")),1),e("div",Oa,[e("label",Aa,[e("span",Ua,n(i(r)("dashboard.filters.date")),1),e("div",Ea,[w(e("input",{class:"dashboard__input",type:"date","onUpdate:modelValue":o[0]||(o[0]=a=>s.start=a),onChange:Y},null,544),[[F,s.start]]),o[7]||(o[7]=e("span",{class:"dashboard__date-separator"},"—",-1)),w(e("input",{class:"dashboard__input",type:"date","onUpdate:modelValue":o[1]||(o[1]=a=>s.end=a),onChange:Y},null,544),[[F,s.end]])])]),e("label",La,[e("span",Pa,n(i(r)("dashboard.filters.granularity")),1),w(e("select",{class:"dashboard__input","onUpdate:modelValue":o[2]||(o[2]=a=>s.granularity=a)},[(l(),d(m,null,y(ta,a=>e("option",{key:a.value,value:a.value},n(i(r)(a.label)),9,Ka)),64))],512),[[Z,s.granularity]])]),e("label",Ba,[e("span",Ga,n(i(r)("dashboard.filters.company")),1),w(e("input",{class:"dashboard__input",type:"text","onUpdate:modelValue":o[3]||(o[3]=a=>s.companyId=a),placeholder:"ID / 别名"},null,512),[[F,s.companyId]])]),e("label",ja,[e("span",Ha,n(i(r)("dashboard.filters.city")),1),w(e("input",{class:"dashboard__input",type:"text","onUpdate:modelValue":o[4]||(o[4]=a=>s.city=a),placeholder:"City Code"},null,512),[[F,s.city]])]),e("label",Wa,[e("span",Ya,n(i(r)("dashboard.filters.channel")),1),w(e("select",{class:"dashboard__input",multiple:"","onUpdate:modelValue":o[5]||(o[5]=a=>s.channel=a)},[(l(!0),d(m,null,y(ra.value,a=>(l(),d("option",{key:a.value,value:a.value},n(a.label),9,Qa))),128))],512),[[Z,s.channel]]),e("span",Ja,n(i(r)("dashboard.filters.channelHint")),1)])]),e("div",Xa,[e("span",Za,n(i(r)("dashboard.filters.quick")),1),e("div",ae,[(l(),d(m,null,y(sa,a=>e("button",{key:a.value,type:"button",class:S(["dashboard__quick-btn",{"is-active":u.value===a.value}]),onClick:v=>W(a.value)},n(i(r)(a.label)),11,ee)),64)),e("button",{type:"button",class:"dashboard__quick-btn dashboard__quick-btn--ghost",onClick:da},n(i(r)("dashboard.filters.reset")),1)])])])],32),e("section",{class:S(["dashboard__kpis",{"is-loading":c.value}])},[(l(!0),d(m,null,y(B.value,a=>(l(),d("article",{key:a.key,class:"dashboard__kpi-card",onClick:v=>z(a.drill_link),role:"button",tabindex:"0",onKeydown:[aa(O(v=>z(a.drill_link),["prevent"]),["enter"]),aa(O(v=>z(a.drill_link),["prevent"]),["space"])]},[e("header",se,[e("span",oe,n(a.label),1),e("span",{class:"dashboard__kpi-trend","data-trend":a.trend},[a.trend==="up"?(l(),d("span",ne,"▲")):a.trend==="down"?(l(),d("span",de,"▼")):(l(),d("span",le,"■"))],8,re)]),e("div",ie,[e("span",ce,n(a.formattedValue),1),e("span",_e,n(a.unit),1)]),a.formattedDelta?(l(),d("p",he,n(a.formattedDelta),1)):b("",!0)],40,te))),128)),!B.value.length&&!c.value?(l(),d("p",ue,n(i(r)("dashboard.empty")),1)):b("",!0)],2),e("section",{class:S(["dashboard__charts",{"is-loading":c.value}])},[e("article",be,[e("header",ve,[e("div",null,[e("h2",pe,n(i(r)("dashboard.chart.title")),1),e("p",me,n(i(r)("dashboard.chart.metricLabel")),1)]),e("div",ye,[(l(!0),d(m,null,y(oa.value,a=>(l(),d("button",{key:a.value,type:"button",class:S(["dashboard__quick-btn",{"is-active":h.value===a.value}]),onClick:v=>la(a.value)},n(a.label),11,fe))),128))])]),C.value.length?(l(),d("div",ge,[e("ul",ke,[(l(!0),d(m,null,y(C.value,a=>(l(),d("li",{key:a.ts,class:"trend-chart__item"},[e("div",we,[e("span",{class:"trend-chart__value",style:A({height:N(a.value)})},null,4),a.baseline_yesterday!==void 0?(l(),d("span",{key:0,class:"trend-chart__marker trend-chart__marker--yesterday",style:A({bottom:N(a.baseline_yesterday)}),title:i(r)("dashboard.chart.baselineYesterday")},null,12,De)):b("",!0),a.baseline_lastweek!==void 0?(l(),d("span",{key:1,class:"trend-chart__marker trend-chart__marker--lastweek",style:A({bottom:N(a.baseline_lastweek)}),title:i(r)("dashboard.chart.baselineLastWeek")},null,12,$e)):b("",!0)]),e("time",Ce,n(ia(a.ts)),1)]))),128))])])):(l(),d("p",qe,n(i(r)("dashboard.empty")),1))]),G.value.length?(l(),d("article",Me,[e("header",Ie,[e("h2",xe,n(i(r)("dashboard.compare.title")),1)]),e("table",Fe,[e("thead",null,[e("tr",null,[e("th",Se,n(i(r)("dashboard.compare.metric")),1),e("th",Te,n(i(r)("dashboard.compare.current")),1),e("th",Ve,n(i(r)("dashboard.compare.previous")),1),e("th",ze,n(i(r)("dashboard.compare.change")),1)])]),e("tbody",null,[(l(!0),d(m,null,y(G.value,a=>(l(),d("tr",{key:a.key},[e("th",Ne,n(a.label),1),e("td",null,n(Q(a.current,a.key)),1),e("td",null,n(Q(a.previous,a.key)),1),e("td",null,[e("span",{class:"dashboard__badge","data-positive":a.change>=0},n(ca(a)),9,Re)])]))),128))])])])):b("",!0)],2),_.value?(l(),d("p",Oe,n(_.value),1)):c.value?(l(),d("p",Ae,n(i(r)("dashboard.loading")),1)):b("",!0)]))}}),Pe=fa(Ue,[["__scopeId","data-v-dfee8f86"]]);export{Pe as default};
